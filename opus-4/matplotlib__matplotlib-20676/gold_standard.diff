From 5c08ff65b884bd03d80eba0a6de01a9d24599299 Mon Sep 17 00:00:00 2001
From: Eric Prestat <eric.prestat@gmail.com>
Date: Mon, 19 Jul 2021 10:40:40 +0100
Subject: [PATCH] Fix keeping bound when initialising `SpanSelector`.

---
 lib/matplotlib/tests/test_widgets.py | 29 ++++++++++++++++++++++++++++
 lib/matplotlib/widgets.py            |  7 ++++++-
 2 files changed, 35 insertions(+), 1 deletion(-)

diff --git a/lib/matplotlib/tests/test_widgets.py b/lib/matplotlib/tests/test_widgets.py
index 71ebd176f0b9..19094bca85ef 100644
--- a/lib/matplotlib/tests/test_widgets.py
+++ b/lib/matplotlib/tests/test_widgets.py
@@ -302,6 +302,35 @@ def test_tool_line_handle():
     assert tool_line_handle.positions == positions
 
 
+@pytest.mark.parametrize('direction', ("horizontal", "vertical"))
+def test_span_selector_bound(direction):
+    fig, ax = plt.subplots(1, 1)
+    ax.plot([10, 20], [10, 30])
+    ax.figure.canvas.draw()
+    x_bound = ax.get_xbound()
+    y_bound = ax.get_ybound()
+
+    tool = widgets.SpanSelector(ax, print, direction, interactive=True)
+    assert ax.get_xbound() == x_bound
+    assert ax.get_ybound() == y_bound
+
+    bound = x_bound if direction == 'horizontal' else y_bound
+    assert tool._edge_handles.positions == list(bound)
+
+    press_data = [10.5, 11.5]
+    move_data = [11, 13]  # Updating selector is done in onmove
+    release_data = move_data
+    do_event(tool, 'press', xdata=press_data[0], ydata=press_data[1], button=1)
+    do_event(tool, 'onmove', xdata=move_data[0], ydata=move_data[1], button=1)
+
+    assert ax.get_xbound() == x_bound
+    assert ax.get_ybound() == y_bound
+
+    index = 0 if direction == 'horizontal' else 1
+    handle_positions = [press_data[index], release_data[index]]
+    assert tool._edge_handles.positions == handle_positions
+
+
 def check_lasso_selector(**kwargs):
     ax = get_ax()
 
diff --git a/lib/matplotlib/widgets.py b/lib/matplotlib/widgets.py
index a199e45d4018..00759db0be23 100644
--- a/lib/matplotlib/widgets.py
+++ b/lib/matplotlib/widgets.py
@@ -2156,7 +2156,12 @@ def new_axes(self, ax):
             self.artists.append(self._rect)
 
     def _setup_edge_handle(self, props):
-        self._edge_handles = ToolLineHandles(self.ax, self.extents,
+        # Define initial position using the axis bounds to keep the same bounds
+        if self.direction == 'horizontal':
+            positions = self.ax.get_xbound()
+        else:
+            positions = self.ax.get_ybound()
+        self._edge_handles = ToolLineHandles(self.ax, positions,
                                              direction=self.direction,
                                              line_props=props,
                                              useblit=self.useblit)
