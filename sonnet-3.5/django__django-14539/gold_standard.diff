From e11d85721ba142b68773b2d35f3f4f747f6630de Mon Sep 17 00:00:00 2001
From: Shipeng Feng <fsp261@gmail.com>
Date: Wed, 7 Jul 2021 16:09:02 +0800
Subject: [PATCH] Fixed #32866 -- Fixed trimming trailing punctuation from
 escaped string in urlize().

---
 django/utils/html.py           | 5 +++--
 tests/utils_tests/test_html.py | 4 ++++
 2 files changed, 7 insertions(+), 2 deletions(-)

diff --git a/django/utils/html.py b/django/utils/html.py
index 3bc02b8dd3aa..bd58317a7944 100644
--- a/django/utils/html.py
+++ b/django/utils/html.py
@@ -283,8 +283,9 @@ def trim_punctuation(lead, middle, trail):
             middle_unescaped = html.unescape(middle)
             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)
             if middle_unescaped != stripped:
-                trail = middle[len(stripped):] + trail
-                middle = middle[:len(stripped) - len(middle_unescaped)]
+                punctuation_count = len(middle_unescaped) - len(stripped)
+                trail = middle[-punctuation_count:] + trail
+                middle = middle[:-punctuation_count]
                 trimmed_something = True
         return lead, middle, trail
 
diff --git a/tests/utils_tests/test_html.py b/tests/utils_tests/test_html.py
index 30f5ba68e862..909620ea3f1b 100644
--- a/tests/utils_tests/test_html.py
+++ b/tests/utils_tests/test_html.py
@@ -250,6 +250,10 @@ def test_urlize(self):
                 'Search for google.com/?q=! and see.',
                 'Search for <a href="http://google.com/?q=">google.com/?q=</a>! and see.'
             ),
+            (
+                'Search for google.com/?q=1&lt! and see.',
+                'Search for <a href="http://google.com/?q=1%3C">google.com/?q=1&lt</a>! and see.'
+            ),
             (
                 lazystr('Search for google.com/?q=!'),
                 'Search for <a href="http://google.com/?q=">google.com/?q=</a>!'
