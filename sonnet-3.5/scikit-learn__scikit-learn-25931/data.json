{"instance_id": "scikit-learn__scikit-learn-25931", "score": "C", "diff": "diff --git a/sklearn/ensemble/_iforest.py b/sklearn/ensemble/_iforest.py\nindex 4d6c1c3f0..431365a64 100644\n--- a/sklearn/ensemble/_iforest.py\n+++ b/sklearn/ensemble/_iforest.py\n@@ -345,7 +345,8 @@ class IsolationForest(OutlierMixin, BaseBagging):\n             return self\n \n         # else, define offset_ wrt contamination parameter\n-        self.offset_ = np.percentile(self.score_samples(X), 100.0 * self.contamination)\n+        scores = -self._compute_chunked_score_samples(X)\n+        self.offset_ = np.percentile(scores, 100.0 * self.contamination)\n \n         return self\n \n", "gold_standard_diff": "From 07a2beee79475e3aaa9160378f1e595f306ebbd6 Mon Sep 17 00:00:00 2001\nFrom: Charlie-XIAO <yx2436@nyu.edu>\nDate: Wed, 22 Mar 2023 07:10:13 +0800\nSubject: [PATCH 1/5] added non-regression test for whether feature names are\n preserved by IsolationForest when contamination is not \"auto\"\n\n---\n sklearn/ensemble/tests/test_iforest.py | 17 +++++++++++++++++\n 1 file changed, 17 insertions(+)\n\ndiff --git a/sklearn/ensemble/tests/test_iforest.py b/sklearn/ensemble/tests/test_iforest.py\nindex 5f046540fffdc..e9fa1c954b018 100644\n--- a/sklearn/ensemble/tests/test_iforest.py\n+++ b/sklearn/ensemble/tests/test_iforest.py\n@@ -339,3 +339,20 @@ def test_base_estimator_property_deprecated():\n     )\n     with pytest.warns(FutureWarning, match=warn_msg):\n         model.base_estimator_\n+    \n+def test_iforest_preserve_feature_names():\n+    \"\"\"Check that feature names are preserved when contamination is not \"auto\".\n+\n+    Feature names are required for consistency checks during scoring.\n+    \n+    Non-regression test for Issue #25844\n+    \"\"\"\n+    pd = pytest.importorskip(\"pandas\")\n+    rng = np.random.RandomState(0)\n+\n+    X = pd.DataFrame(data=rng.randn(4), columns=[\"a\"])\n+    model = IsolationForest(random_state=0, contamination=0.05)\n+\n+    with warnings.catch_warnings():\n+        warnings.simplefilter(\"error\", UserWarning)\n+        model.fit(X)\n\nFrom 13ab33dc76fcce3fa604ff088d33162ecdb8acfa Mon Sep 17 00:00:00 2001\nFrom: Charlie-XIAO <yx2436@nyu.edu>\nDate: Wed, 22 Mar 2023 08:10:20 +0800\nSubject: [PATCH 2/5] Fixed \"IsolationForest removes features when called with\n contamination not 'auto'\" Also see Issue #25844, now does not generate\n warnings\n\n---\n sklearn/ensemble/_iforest.py | 24 ++++++++++++++++--------\n 1 file changed, 16 insertions(+), 8 deletions(-)\n\ndiff --git a/sklearn/ensemble/_iforest.py b/sklearn/ensemble/_iforest.py\nindex 4d6c1c3f0b7f9..d7d2707b953d9 100644\n--- a/sklearn/ensemble/_iforest.py\n+++ b/sklearn/ensemble/_iforest.py\n@@ -344,8 +344,10 @@ def fit(self, X, y=None, sample_weight=None):\n             self.offset_ = -0.5\n             return self\n \n-        # else, define offset_ wrt contamination parameter\n-        self.offset_ = np.percentile(self.score_samples(X), 100.0 * self.contamination)\n+        # Else, define offset_ wrt contamination parameter\n+        # Input validation would remove feature names, so we call private version\n+        # of score_sample that does not perform input validation\n+        self.offset_ = np.percentile(self._score_samples(X), 100.0 * self.contamination)\n \n         return self\n \n@@ -428,15 +430,21 @@ def score_samples(self, X):\n             The anomaly score of the input samples.\n             The lower, the more abnormal.\n         \"\"\"\n-        # code structure from ForestClassifier/predict_proba\n-\n-        check_is_fitted(self)\n-\n         # Check data\n         X = self._validate_data(X, accept_sparse=\"csr\", dtype=np.float32, reset=False)\n \n-        # Take the opposite of the scores as bigger is better (here less\n-        # abnormal)\n+        return self._score_samples(X)\n+    \n+    def _score_samples(self, X):\n+        \"\"\"Private version of score_samples without input validation.\n+        \n+        Input validation would remove feature names, so we disable it.\n+        \"\"\"\n+        # Code structure from ForestClassifier/predict_proba\n+\n+        check_is_fitted(self)\n+\n+        # Take the opposite of the scores as bigger is better (here less abnormal)\n         return -self._compute_chunked_score_samples(X)\n \n     def _compute_chunked_score_samples(self, X):\n\nFrom b630df0c3e287122be3217835bdc61722be0bb46 Mon Sep 17 00:00:00 2001\nFrom: Charlie-XIAO <yx2436@nyu.edu>\nDate: Wed, 22 Mar 2023 08:54:25 +0800\nSubject: [PATCH 3/5] added an entry to the changelog at v1.3.rst\n\n---\n doc/whats_new/v1.3.rst | 4 ++++\n 1 file changed, 4 insertions(+)\n\ndiff --git a/doc/whats_new/v1.3.rst b/doc/whats_new/v1.3.rst\nindex dac97146be221..87d42e1d79b44 100644\n--- a/doc/whats_new/v1.3.rst\n+++ b/doc/whats_new/v1.3.rst\n@@ -232,6 +232,10 @@ Changelog\n   when `max_samples` is a float and `round(n_samples * max_samples) < 1`.\n   :pr:`25601` by :user:`Jan Fidor <JanFidor>`.\n \n+- |Fix| :meth:`ensemble.IsolationForest.fit` no longer removes feature names\n+  or gives warnings when called with `contamination` not `\"auto\"`.\n+  :pr:`25931` by :user:`Yao Xiao <Charlie-XIAO>`.\n+\n :mod:`sklearn.exception`\n ........................\n - |Feature| Added :class:`exception.InconsistentVersionWarning` which is raised\n\nFrom 171fff5a976e0fa78f67b74aa82818d28ba34c2a Mon Sep 17 00:00:00 2001\nFrom: Charlie-XIAO <yx2436@nyu.edu>\nDate: Wed, 22 Mar 2023 09:04:16 +0800\nSubject: [PATCH 4/5] code style check, removed some leading spaces\n\n---\n sklearn/ensemble/_iforest.py           | 4 ++--\n sklearn/ensemble/tests/test_iforest.py | 5 +++--\n 2 files changed, 5 insertions(+), 4 deletions(-)\n\ndiff --git a/sklearn/ensemble/_iforest.py b/sklearn/ensemble/_iforest.py\nindex d7d2707b953d9..8858308c46988 100644\n--- a/sklearn/ensemble/_iforest.py\n+++ b/sklearn/ensemble/_iforest.py\n@@ -434,10 +434,10 @@ def score_samples(self, X):\n         X = self._validate_data(X, accept_sparse=\"csr\", dtype=np.float32, reset=False)\n \n         return self._score_samples(X)\n-    \n+\n     def _score_samples(self, X):\n         \"\"\"Private version of score_samples without input validation.\n-        \n+\n         Input validation would remove feature names, so we disable it.\n         \"\"\"\n         # Code structure from ForestClassifier/predict_proba\ndiff --git a/sklearn/ensemble/tests/test_iforest.py b/sklearn/ensemble/tests/test_iforest.py\nindex e9fa1c954b018..7650dd5c14ce4 100644\n--- a/sklearn/ensemble/tests/test_iforest.py\n+++ b/sklearn/ensemble/tests/test_iforest.py\n@@ -339,12 +339,13 @@ def test_base_estimator_property_deprecated():\n     )\n     with pytest.warns(FutureWarning, match=warn_msg):\n         model.base_estimator_\n-    \n+\n+\n def test_iforest_preserve_feature_names():\n     \"\"\"Check that feature names are preserved when contamination is not \"auto\".\n \n     Feature names are required for consistency checks during scoring.\n-    \n+\n     Non-regression test for Issue #25844\n     \"\"\"\n     pd = pytest.importorskip(\"pandas\")\n\nFrom f4eace5c5364aa3bb6e7b6eede03c3d78955aa49 Mon Sep 17 00:00:00 2001\nFrom: Charlie-XIAO <yx2436@nyu.edu>\nDate: Wed, 22 Mar 2023 20:18:53 +0800\nSubject: [PATCH 5/5] adopted changes @ogrisel @lesteve, resolved conversations\n\n---\n doc/whats_new/v1.3.rst       | 5 +++--\n sklearn/ensemble/_iforest.py | 4 ++--\n 2 files changed, 5 insertions(+), 4 deletions(-)\n\ndiff --git a/doc/whats_new/v1.3.rst b/doc/whats_new/v1.3.rst\nindex 87d42e1d79b44..99cbaadf9b76a 100644\n--- a/doc/whats_new/v1.3.rst\n+++ b/doc/whats_new/v1.3.rst\n@@ -232,8 +232,9 @@ Changelog\n   when `max_samples` is a float and `round(n_samples * max_samples) < 1`.\n   :pr:`25601` by :user:`Jan Fidor <JanFidor>`.\n \n-- |Fix| :meth:`ensemble.IsolationForest.fit` no longer removes feature names\n-  or gives warnings when called with `contamination` not `\"auto\"`.\n+- |Fix| :meth:`ensemble.IsolationForest.fit` no longer warns about missing\n+  feature names when called with `contamination` not `\"auto\"` on a pandas\n+  dataframe.\n   :pr:`25931` by :user:`Yao Xiao <Charlie-XIAO>`.\n \n :mod:`sklearn.exception`\ndiff --git a/sklearn/ensemble/_iforest.py b/sklearn/ensemble/_iforest.py\nindex 8858308c46988..cc0f3cf09dee7 100644\n--- a/sklearn/ensemble/_iforest.py\n+++ b/sklearn/ensemble/_iforest.py\n@@ -345,8 +345,8 @@ def fit(self, X, y=None, sample_weight=None):\n             return self\n \n         # Else, define offset_ wrt contamination parameter\n-        # Input validation would remove feature names, so we call private version\n-        # of score_sample that does not perform input validation\n+        # To avoid performing input validation a second time we call\n+        # _score_samples rather than score_samples\n         self.offset_ = np.percentile(self._score_samples(X), 100.0 * self.contamination)\n \n         return self\n", "gold_standard_pr_link": "https://github.com/scikit-learn/scikit-learn/pull/25931"}