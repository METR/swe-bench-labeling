{"instance_id": "sphinx-doc__sphinx-10323", "score": "I", "diff": "diff --git a/sphinx/directives/code.py b/sphinx/directives/code.py\nindex dc44ed314..bdfd524a2 100644\n--- a/sphinx/directives/code.py\n+++ b/sphinx/directives/code.py\n@@ -343,14 +343,28 @@ class LiteralIncludeReader:\n     def prepend_filter(self, lines: List[str], location: Tuple[str, int] = None) -> List[str]:\n         prepend = self.options.get('prepend')\n         if prepend:\n-            lines.insert(0, prepend + '\\n')\n+            # Determine the indentation of the first non-empty line\n+            indent = ''\n+            for line in lines:\n+                if line.strip():\n+                    indent = line[:len(line) - len(line.lstrip())]\n+                    break\n+            # Prepend the content with the same indentation\n+            lines.insert(0, indent + prepend + '\\n')\n \n         return lines\n \n     def append_filter(self, lines: List[str], location: Tuple[str, int] = None) -> List[str]:\n         append = self.options.get('append')\n         if append:\n-            lines.append(append + '\\n')\n+            # Determine the indentation of the last non-empty line\n+            indent = ''\n+            for line in reversed(lines):\n+                if line.strip():\n+                    indent = line[:len(line) - len(line.lstrip())]\n+                    break\n+            # Append the content with the same indentation\n+            lines.append(indent + append + '\\n')\n \n         return lines\n \ndiff --git a/tox.ini b/tox.ini\nindex f0afd779b..30ca90275 100644\n--- a/tox.ini\n+++ b/tox.ini\n@@ -28,7 +28,7 @@ setenv =\n     PYTHONWARNINGS = all\n     PYTEST_ADDOPTS = {env:PYTEST_ADDOPTS:} --color yes\n commands=\n-    python -X dev -m pytest --durations 25 {posargs}\n+    python -X dev -m pytest -rA --durations 25 {posargs}\n \n [testenv:du-latest]\n commands =\n", "gold_standard_diff": "diff --git a/CHANGES b/CHANGES\nindex 7037723fe50..581c22a5120 100644\n--- a/CHANGES\n+++ b/CHANGES\n@@ -72,6 +72,8 @@ Bugs fixed\n   bulding texinfo document\n * #10000: LaTeX: glossary terms with common definition are rendered with\n   too much vertical whitespace\n+* #10318: ``:prepend:`` option of :rst:dir:`literalinclude` directive does not\n+  work with ``:dedent:`` option\n \n Testing\n --------\ndiff --git a/sphinx/directives/code.py b/sphinx/directives/code.py\nindex dc44ed31485..9437fe9a5e5 100644\n--- a/sphinx/directives/code.py\n+++ b/sphinx/directives/code.py\n@@ -224,9 +224,9 @@ def read(self, location: Tuple[str, int] = None) -> Tuple[str, int]:\n                        self.start_filter,\n                        self.end_filter,\n                        self.lines_filter,\n+                       self.dedent_filter,\n                        self.prepend_filter,\n-                       self.append_filter,\n-                       self.dedent_filter]\n+                       self.append_filter]\n             lines = self.read_file(self.filename, location=location)\n             for func in filters:\n                 lines = func(lines, location=location)\ndiff --git a/tests/test_directive_code.py b/tests/test_directive_code.py\nindex 98a9aa89940..cc73c426ce2 100644\n--- a/tests/test_directive_code.py\n+++ b/tests/test_directive_code.py\n@@ -251,6 +251,19 @@ def test_LiteralIncludeReader_dedent(literal_inc_path):\n                        \"\\n\")\n \n \n+@pytest.mark.xfail(os.name != 'posix', reason=\"Not working on windows\")\n+def test_LiteralIncludeReader_dedent_and_append_and_prepend(literal_inc_path):\n+    # dedent: 2\n+    options = {'lines': '9-11', 'dedent': 2, 'prepend': 'class Foo:', 'append': '# comment'}\n+    reader = LiteralIncludeReader(literal_inc_path, options, DUMMY_CONFIG)\n+    content, lines = reader.read()\n+    assert content == (\"class Foo:\\n\"\n+                       \"  def baz():\\n\"\n+                       \"      pass\\n\"\n+                       \"\\n\"\n+                       \"# comment\\n\")\n+\n+\n @pytest.mark.xfail(os.name != 'posix', reason=\"Not working on windows\")\n def test_LiteralIncludeReader_tabwidth(testroot):\n     # tab-width: 4\n", "gold_standard_pr_link": "https://github.com/sphinx-doc/sphinx/pull/10323"}