{"instance_id": "sympy__sympy-19040", "score": "I", "diff": "diff --git a/sympy/polys/polytools.py b/sympy/polys/polytools.py\nindex 68b69d1a24..f8d59646c6 100644\n--- a/sympy/polys/polytools.py\n+++ b/sympy/polys/polytools.py\n@@ -6274,6 +6274,10 @@ def factor(f, *gens, **args):\n     over other domain, e.g. an algebraic or finite field, use appropriate\n     options: ``extension``, ``modulus`` or ``domain``.\n \n+    When the ``extension`` option is used, the function ensures that all\n+    factors are preserved, including those that might not involve the\n+    extension.\n+\n     Examples\n     ========\n \n@@ -6346,6 +6350,14 @@ def _try_factor(expr):\n                 partials[p] = fac\n         return f.xreplace(partials)\n \n+    # Handle the case when extension is provided\n+    if 'extension' in args:\n+        from sympy import expand, Mul\n+        expanded_f = expand(f)\n+        factors = _generic_factor_list(expanded_f, gens, args, method='factor')\n+        # Ensure all factors are preserved\n+        return Mul(*[factor**power for factor, power in factors[1]], evaluate=False) * factors[0]\n+\n     try:\n         return _generic_factor(f, gens, args, method='factor')\n     except PolynomialError as msg:\ndiff --git a/sympy/polys/tests/test_factortools.py b/sympy/polys/tests/test_factortools.py\nindex 7bcd935756..b03b529b67 100644\n--- a/sympy/polys/tests/test_factortools.py\n+++ b/sympy/polys/tests/test_factortools.py\n@@ -681,3 +681,21 @@ def test_dmp_irreducible_p():\n     R, x, y = ring(\"x,y\", ZZ)\n     assert R.dmp_irreducible_p(x**2 + x + 1) is True\n     assert R.dmp_irreducible_p(x**2 + 2*x + 1) is False\n+\n+def test_factor_with_extension():\n+    from sympy import factor, expand, I\n+    from sympy.abc import x, y\n+\n+    # Test case for the issue\n+    f = expand((x - 1) * (y - 1))\n+    assert factor(f) == (x - 1) * (y - 1)\n+    assert factor(f, extension=[I]) == (x - 1) * (y - 1)\n+\n+    # Additional test cases\n+    f = expand((x - I) * (x + I) * (y - 1))\n+    assert factor(f) == (x**2 + 1) * (y - 1)\n+    assert factor(f, extension=[I]) == (x - I) * (x + I) * (y - 1)\n+\n+    f = expand((x - 1) * (x - 2) * (y - 3))\n+    assert factor(f) == (x - 1) * (x - 2) * (y - 3)\n+    assert factor(f, extension=[I]) == (x - 1) * (x - 2) * (y - 3)\n\\ No newline at end of file\n", "gold_standard_diff": "diff --git a/sympy/polys/factortools.py b/sympy/polys/factortools.py\nindex c6a5f9f0630a..93298f47e671 100644\n--- a/sympy/polys/factortools.py\n+++ b/sympy/polys/factortools.py\n@@ -1147,7 +1147,7 @@ def dmp_ext_factor(f, u, K):\n         return lc, []\n \n     f, F = dmp_sqf_part(f, u, K), f\n-    s, g, r = dmp_sqf_norm(f, u, K)\n+    s, g, r = dmp_sqf_norm(F, u, K)\n \n     factors = dmp_factor_list_include(r, u, K.dom)\n \ndiff --git a/sympy/polys/tests/test_polytools.py b/sympy/polys/tests/test_polytools.py\nindex b0b4cd61322a..174c86c4d85c 100644\n--- a/sympy/polys/tests/test_polytools.py\n+++ b/sympy/polys/tests/test_polytools.py\n@@ -58,7 +58,7 @@\n from sympy.core.basic import _aresame\n from sympy.core.compatibility import iterable\n from sympy.core.mul import _keep_coeff\n-from sympy.testing.pytest import raises, XFAIL, warns_deprecated_sympy\n+from sympy.testing.pytest import raises, warns_deprecated_sympy\n \n from sympy.abc import a, b, c, d, p, q, t, w, x, y, z\n from sympy import MatrixSymbol, Matrix\n@@ -3249,7 +3249,6 @@ def test_poly_matching_consistency():\n     assert Poly(x, x) * I == Poly(I*x, x)\n \n \n-@XFAIL\n def test_issue_5786():\n     assert expand(factor(expand(\n         (x - I*y)*(z - I*t)), extension=[I])) == -I*t*x - t*y + x*z - I*y*z\n", "gold_standard_pr_link": "https://github.com/sympy/sympy/pull/19040"}