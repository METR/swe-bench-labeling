From 864a0b377d3ef6526837dfb721c260587ccb64f9 Mon Sep 17 00:00:00 2001
From: Raymond Sun <raymondsun33@gmail.com>
Date: Fri, 11 Jun 2021 23:06:03 +1000
Subject: [PATCH 1/6] Add test

---
 tests/test_quickstart.py | 16 +++++++++++++++-
 1 file changed, 15 insertions(+), 1 deletion(-)

diff --git a/tests/test_quickstart.py b/tests/test_quickstart.py
index 94144ef2210..96b11daec7f 100644
--- a/tests/test_quickstart.py
+++ b/tests/test_quickstart.py
@@ -10,6 +10,7 @@
 
 import time
 from io import StringIO
+from os import path
 
 import pytest
 
@@ -122,7 +123,6 @@ def test_quickstart_defaults(tempdir):
     assert (tempdir / 'Makefile').isfile()
     assert (tempdir / 'make.bat').isfile()
 
-
 def test_quickstart_all_answers(tempdir):
     answers = {
         'Root path': tempdir,
@@ -250,3 +250,17 @@ def test_extensions(tempdir):
     ns = {}
     exec(conffile.read_text(), ns)
     assert ns['extensions'] == ['foo', 'bar', 'baz']
+
+def test_easy_exit_when_existing_confpy(monkeypatch):
+    # The code detects existing conf.py with isfile() so we mock it
+    def mock_isfile(path):
+        return True
+    monkeypatch.setattr(path, 'isfile', mock_isfile)
+    
+    answers = {
+        'Please enter a new root path': '',
+    }
+    qs.term_input = mock_input(answers)
+    d = {}
+    with pytest.raises(SystemExit):
+        qs.ask_user(d)
\ No newline at end of file

From 025db046580c400ad9a6d7eb04434bfc46ce3300 Mon Sep 17 00:00:00 2001
From: Raymond Sun <raymondsun33@gmail.com>
Date: Fri, 11 Jun 2021 23:06:29 +1000
Subject: [PATCH 2/6] Add fix

---
 sphinx/cmd/quickstart.py | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/sphinx/cmd/quickstart.py b/sphinx/cmd/quickstart.py
index a40a2107310..29f1c50a63a 100644
--- a/sphinx/cmd/quickstart.py
+++ b/sphinx/cmd/quickstart.py
@@ -223,7 +223,7 @@ def ask_user(d: Dict) -> None:
         print(__('sphinx-quickstart will not overwrite existing Sphinx projects.'))
         print()
         d['path'] = do_prompt(__('Please enter a new root path (or just Enter to exit)'),
-                              '', is_path)
+                              '', ok)
         if not d['path']:
             sys.exit(1)
 

From 81049deed6a9daaa887abd3cbf217237e225302d Mon Sep 17 00:00:00 2001
From: Raymond Sun <raymondsun33@gmail.com>
Date: Sat, 12 Jun 2021 00:07:34 +1000
Subject: [PATCH 3/6] Make quickstart just exit without reprompting

---
 sphinx/cmd/quickstart.py | 7 ++-----
 tests/test_quickstart.py | 9 +++------
 2 files changed, 5 insertions(+), 11 deletions(-)

diff --git a/sphinx/cmd/quickstart.py b/sphinx/cmd/quickstart.py
index 29f1c50a63a..1b2eacc95e9 100644
--- a/sphinx/cmd/quickstart.py
+++ b/sphinx/cmd/quickstart.py
@@ -220,12 +220,9 @@ def ask_user(d: Dict) -> None:
         print()
         print(bold(__('Error: an existing conf.py has been found in the '
                       'selected root path.')))
-        print(__('sphinx-quickstart will not overwrite existing Sphinx projects.'))
+        print(__('sphinx-quickstart will not overwrite existing Sphinx projects. Try another directory?'))
         print()
-        d['path'] = do_prompt(__('Please enter a new root path (or just Enter to exit)'),
-                              '', ok)
-        if not d['path']:
-            sys.exit(1)
+        sys.exit(1)
 
     if 'sep' not in d:
         print()
diff --git a/tests/test_quickstart.py b/tests/test_quickstart.py
index 96b11daec7f..4ee5535cb65 100644
--- a/tests/test_quickstart.py
+++ b/tests/test_quickstart.py
@@ -251,16 +251,13 @@ def test_extensions(tempdir):
     exec(conffile.read_text(), ns)
     assert ns['extensions'] == ['foo', 'bar', 'baz']
 
-def test_easy_exit_when_existing_confpy(monkeypatch):
+def test_exits_upon_existing_confpy(monkeypatch):
     # The code detects existing conf.py with isfile() so we mock it
     def mock_isfile(path):
         return True
     monkeypatch.setattr(path, 'isfile', mock_isfile)
     
-    answers = {
-        'Please enter a new root path': '',
-    }
-    qs.term_input = mock_input(answers)
+    qs.term_input = mock_input({})
     d = {}
     with pytest.raises(SystemExit):
-        qs.ask_user(d)
\ No newline at end of file
+        qs.ask_user(d)

From 17114d7741e8f2c32d477c09f2bae7affd95bba8 Mon Sep 17 00:00:00 2001
From: Raymond Sun <raymondsun33@gmail.com>
Date: Sat, 12 Jun 2021 00:19:12 +1000
Subject: [PATCH 4/6] Edit message

---
 sphinx/cmd/quickstart.py | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/sphinx/cmd/quickstart.py b/sphinx/cmd/quickstart.py
index 1b2eacc95e9..359355ad11b 100644
--- a/sphinx/cmd/quickstart.py
+++ b/sphinx/cmd/quickstart.py
@@ -220,7 +220,7 @@ def ask_user(d: Dict) -> None:
         print()
         print(bold(__('Error: an existing conf.py has been found in the '
                       'selected root path.')))
-        print(__('sphinx-quickstart will not overwrite existing Sphinx projects. Try another directory?'))
+        print(__('sphinx-quickstart will not overwrite existing Sphinx projects.'))
         print()
         sys.exit(1)
 

From 6a9cc9e5ea9a8baca2e289ed1f2c925e6e610ea3 Mon Sep 17 00:00:00 2001
From: Raymond Sun <raymondsun33@gmail.com>
Date: Mon, 14 Jun 2021 15:57:50 +1000
Subject: [PATCH 5/6] Fix flake8 errors

---
 sphinx/cmd/quickstart.py | 11 ++++++++++-
 tests/test_quickstart.py |  4 +++-
 2 files changed, 13 insertions(+), 2 deletions(-)

diff --git a/sphinx/cmd/quickstart.py b/sphinx/cmd/quickstart.py
index 359355ad11b..7dfc29e192f 100644
--- a/sphinx/cmd/quickstart.py
+++ b/sphinx/cmd/quickstart.py
@@ -95,6 +95,12 @@ def is_path(x: str) -> str:
     return x
 
 
+def is_path_or_empty(x: str) -> str:
+    if x == '':
+        return x
+    return is_path(x)
+
+
 def allow_empty(x: str) -> str:
     return x
 
@@ -222,7 +228,10 @@ def ask_user(d: Dict) -> None:
                       'selected root path.')))
         print(__('sphinx-quickstart will not overwrite existing Sphinx projects.'))
         print()
-        sys.exit(1)
+        d['path'] = do_prompt(__('Please enter a new root path (or just Enter to exit)'),
+                              '', is_path_or_empty)
+        if not d['path']:
+            sys.exit(1)
 
     if 'sep' not in d:
         print()
diff --git a/tests/test_quickstart.py b/tests/test_quickstart.py
index 4ee5535cb65..86c9cc6da52 100644
--- a/tests/test_quickstart.py
+++ b/tests/test_quickstart.py
@@ -123,6 +123,7 @@ def test_quickstart_defaults(tempdir):
     assert (tempdir / 'Makefile').isfile()
     assert (tempdir / 'make.bat').isfile()
 
+
 def test_quickstart_all_answers(tempdir):
     answers = {
         'Root path': tempdir,
@@ -251,12 +252,13 @@ def test_extensions(tempdir):
     exec(conffile.read_text(), ns)
     assert ns['extensions'] == ['foo', 'bar', 'baz']
 
+
 def test_exits_upon_existing_confpy(monkeypatch):
     # The code detects existing conf.py with isfile() so we mock it
     def mock_isfile(path):
         return True
     monkeypatch.setattr(path, 'isfile', mock_isfile)
-    
+
     qs.term_input = mock_input({})
     d = {}
     with pytest.raises(SystemExit):

From 9ff16979390a789aefd1585a7c97d80c51c17207 Mon Sep 17 00:00:00 2001
From: Raymond Sun <raymondsun33@gmail.com>
Date: Mon, 14 Jun 2021 16:02:28 +1000
Subject: [PATCH 6/6] Make test more readable

---
 tests/test_quickstart.py | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/tests/test_quickstart.py b/tests/test_quickstart.py
index 86c9cc6da52..02140cf0223 100644
--- a/tests/test_quickstart.py
+++ b/tests/test_quickstart.py
@@ -253,13 +253,16 @@ def test_extensions(tempdir):
     assert ns['extensions'] == ['foo', 'bar', 'baz']
 
 
-def test_exits_upon_existing_confpy(monkeypatch):
-    # The code detects existing conf.py with isfile() so we mock it
+def test_exits_when_existing_confpy(monkeypatch):
+    # The code detects existing conf.py with path.isfile() 
+    # so we mock it as True with pytest's monkeypatch
     def mock_isfile(path):
         return True
     monkeypatch.setattr(path, 'isfile', mock_isfile)
 
-    qs.term_input = mock_input({})
+    qs.term_input = mock_input({
+        'Please enter a new root path (or just Enter to exit)': ''
+    })
     d = {}
     with pytest.raises(SystemExit):
         qs.ask_user(d)
