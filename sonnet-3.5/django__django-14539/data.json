{"instance_id": "django__django-14539", "score": "I", "diff": "diff --git a/django/utils/html.py b/django/utils/html.py\nindex 3bc02b8dd3..2d280b3ea2 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,8 @@ def urlize(text, trim_url_limit=None, nofollow=False, autoescape=False):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                trail = html.escape(middle_unescaped[len(stripped):]) + trail\n+                middle = html.escape(stripped)\n                 trimmed_something = True\n         return lead, middle, trail\n \n", "gold_standard_diff": "From e11d85721ba142b68773b2d35f3f4f747f6630de Mon Sep 17 00:00:00 2001\nFrom: Shipeng Feng <fsp261@gmail.com>\nDate: Wed, 7 Jul 2021 16:09:02 +0800\nSubject: [PATCH] Fixed #32866 -- Fixed trimming trailing punctuation from\n escaped string in urlize().\n\n---\n django/utils/html.py           | 5 +++--\n tests/utils_tests/test_html.py | 4 ++++\n 2 files changed, 7 insertions(+), 2 deletions(-)\n\ndiff --git a/django/utils/html.py b/django/utils/html.py\nindex 3bc02b8dd3aa..bd58317a7944 100644\n--- a/django/utils/html.py\n+++ b/django/utils/html.py\n@@ -283,8 +283,9 @@ def trim_punctuation(lead, middle, trail):\n             middle_unescaped = html.unescape(middle)\n             stripped = middle_unescaped.rstrip(TRAILING_PUNCTUATION_CHARS)\n             if middle_unescaped != stripped:\n-                trail = middle[len(stripped):] + trail\n-                middle = middle[:len(stripped) - len(middle_unescaped)]\n+                punctuation_count = len(middle_unescaped) - len(stripped)\n+                trail = middle[-punctuation_count:] + trail\n+                middle = middle[:-punctuation_count]\n                 trimmed_something = True\n         return lead, middle, trail\n \ndiff --git a/tests/utils_tests/test_html.py b/tests/utils_tests/test_html.py\nindex 30f5ba68e862..909620ea3f1b 100644\n--- a/tests/utils_tests/test_html.py\n+++ b/tests/utils_tests/test_html.py\n@@ -250,6 +250,10 @@ def test_urlize(self):\n                 'Search for google.com/?q=! and see.',\n                 'Search for <a href=\"http://google.com/?q=\">google.com/?q=</a>! and see.'\n             ),\n+            (\n+                'Search for google.com/?q=1&lt! and see.',\n+                'Search for <a href=\"http://google.com/?q=1%3C\">google.com/?q=1&lt</a>! and see.'\n+            ),\n             (\n                 lazystr('Search for google.com/?q=!'),\n                 'Search for <a href=\"http://google.com/?q=\">google.com/?q=</a>!'\n", "gold_standard_pr_link": "https://github.com/django/django/pull/14539"}