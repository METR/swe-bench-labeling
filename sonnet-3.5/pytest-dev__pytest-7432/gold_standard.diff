From 1e432aa09392eb1686f1947671e87d5bd6f6f5f4 Mon Sep 17 00:00:00 2001
From: Arvin Firouzi <427014@student.fontys.nl>
Date: Mon, 29 Jun 2020 23:49:02 +0200
Subject: [PATCH 1/6] Fix issue 7392

---
 src/_pytest/skipping.py | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/_pytest/skipping.py b/src/_pytest/skipping.py
index 7bd975e5a09..058bf2a3824 100644
--- a/src/_pytest/skipping.py
+++ b/src/_pytest/skipping.py
@@ -270,7 +270,7 @@ def pytest_runtest_makereport(item: Item, call: CallInfo[None]):
         else:
             rep.longrepr = "Unexpected success"
         rep.outcome = "failed"
-    elif item.config.option.runxfail:
+    elif item.config.option.runxfail and xfailed:
         pass  # don't interfere
     elif call.excinfo and isinstance(call.excinfo.value, xfail.Exception):
         assert call.excinfo.value.msg is not None

From ec6936cbb8e8c8e761e0607cc83d1be95b07fe56 Mon Sep 17 00:00:00 2001
From: Arvin Firouzi <427014@student.fontys.nl>
Date: Tue, 30 Jun 2020 13:09:47 +0200
Subject: [PATCH 2/6] add changelog and test

---
 changelog/7392.bugfix.rst |  1 +
 testing/test_skipping.py  | 14 ++++++++++++++
 2 files changed, 15 insertions(+)
 create mode 100644 changelog/7392.bugfix.rst

diff --git a/changelog/7392.bugfix.rst b/changelog/7392.bugfix.rst
new file mode 100644
index 00000000000..e346cf196a2
--- /dev/null
+++ b/changelog/7392.bugfix.rst
@@ -0,0 +1 @@
+Fix the issue not ignoring --runxfail when using skip mark in a test.
diff --git a/testing/test_skipping.py b/testing/test_skipping.py
index 0b1c0b49b03..a851e0f41bf 100644
--- a/testing/test_skipping.py
+++ b/testing/test_skipping.py
@@ -235,6 +235,20 @@ def test_func2():
             ["*def test_func():*", "*assert 0*", "*1 failed*1 pass*"]
         )
 
+    def test_xfail_run_with_skip_mark(self, testdir):
+        p = testdir.makepyfile(
+            """
+            import pytest
+            @pytest.mark.skip
+            def test_skip_location() -> None:
+                assert 0
+        """
+        )
+        result = testdir.runpytest(p, "-rs")
+        result.stdout.fnmatch_lines(["*unconditional skip*", "*1 skipped*"])
+        result = testdir.runpytest(p, "-rs --runxfail")
+        result.stdout.fnmatch_lines(["*unconditional skip*", "*1 skipped*"])
+
     def test_xfail_evalfalse_but_fails(self, testdir):
         item = testdir.getitem(
             """

From a54ef1d5492b877d761c36604a51a173a458df46 Mon Sep 17 00:00:00 2001
From: Arvin Firouzi <427014@student.fontys.nl>
Date: Tue, 30 Jun 2020 23:38:07 +0200
Subject: [PATCH 3/6] parametrize test

---
 testing/test_skipping.py | 15 ++++++++++-----
 1 file changed, 10 insertions(+), 5 deletions(-)

diff --git a/testing/test_skipping.py b/testing/test_skipping.py
index a851e0f41bf..887e6a4ef7c 100644
--- a/testing/test_skipping.py
+++ b/testing/test_skipping.py
@@ -235,7 +235,14 @@ def test_func2():
             ["*def test_func():*", "*assert 0*", "*1 failed*1 pass*"]
         )
 
-    def test_xfail_run_with_skip_mark(self, testdir):
+    @pytest.mark.parametrize(
+        "test_input,expected",
+        [
+            ("-rs", ["*unconditional skip*", "*1 skipped*"]),
+            ("-rs --runxfail", ["*unconditional skip*", "*1 skipped*"]),
+        ],
+    )
+    def test_xfail_run_with_skip_mark(self, testdir, test_input, expected):
         p = testdir.makepyfile(
             """
             import pytest
@@ -244,10 +251,8 @@ def test_skip_location() -> None:
                 assert 0
         """
         )
-        result = testdir.runpytest(p, "-rs")
-        result.stdout.fnmatch_lines(["*unconditional skip*", "*1 skipped*"])
-        result = testdir.runpytest(p, "-rs --runxfail")
-        result.stdout.fnmatch_lines(["*unconditional skip*", "*1 skipped*"])
+        result = testdir.runpytest(p, test_input)
+        result.stdout.fnmatch_lines(expected)
 
     def test_xfail_evalfalse_but_fails(self, testdir):
         item = testdir.getitem(

From 5af4f6ff97d2560bbf34a01f3f01b002c302d3a6 Mon Sep 17 00:00:00 2001
From: Arvin Firouzi <427014@student.fontys.nl>
Date: Wed, 1 Jul 2020 14:32:43 +0200
Subject: [PATCH 4/6] change the code to fix the main problem

---
 src/_pytest/skipping.py | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/src/_pytest/skipping.py b/src/_pytest/skipping.py
index 058bf2a3824..c9bdfee89e2 100644
--- a/src/_pytest/skipping.py
+++ b/src/_pytest/skipping.py
@@ -270,7 +270,7 @@ def pytest_runtest_makereport(item: Item, call: CallInfo[None]):
         else:
             rep.longrepr = "Unexpected success"
         rep.outcome = "failed"
-    elif item.config.option.runxfail and xfailed:
+    elif item.config.option.runxfail:
         pass  # don't interfere
     elif call.excinfo and isinstance(call.excinfo.value, xfail.Exception):
         assert call.excinfo.value.msg is not None
@@ -291,7 +291,7 @@ def pytest_runtest_makereport(item: Item, call: CallInfo[None]):
             else:
                 rep.outcome = "passed"
                 rep.wasxfail = xfailed.reason
-    elif (
+    if (
         item._store.get(skipped_by_mark_key, True)
         and rep.skipped
         and type(rep.longrepr) is tuple

From de62197cd8150ea2cc3a2499f995f44ca51b293a Mon Sep 17 00:00:00 2001
From: Arvin Firouzi <427014@student.fontys.nl>
Date: Thu, 9 Jul 2020 20:38:06 +0200
Subject: [PATCH 5/6] fix test and main problem

---
 changelog/7392.bugfix.rst |  2 +-
 src/_pytest/skipping.py   |  1 +
 testing/test_skipping.py  | 12 ++++++------
 3 files changed, 8 insertions(+), 7 deletions(-)

diff --git a/changelog/7392.bugfix.rst b/changelog/7392.bugfix.rst
index e346cf196a2..48cd949faef 100644
--- a/changelog/7392.bugfix.rst
+++ b/changelog/7392.bugfix.rst
@@ -1 +1 @@
-Fix the issue not ignoring --runxfail when using skip mark in a test.
+Fix the reported location of tests skipped with ``@pytest.mark.skip`` when ``--runxfail`` is used.
diff --git a/src/_pytest/skipping.py b/src/_pytest/skipping.py
index c9bdfee89e2..591a65df922 100644
--- a/src/_pytest/skipping.py
+++ b/src/_pytest/skipping.py
@@ -291,6 +291,7 @@ def pytest_runtest_makereport(item: Item, call: CallInfo[None]):
             else:
                 rep.outcome = "passed"
                 rep.wasxfail = xfailed.reason
+
     if (
         item._store.get(skipped_by_mark_key, True)
         and rep.skipped
diff --git a/testing/test_skipping.py b/testing/test_skipping.py
index 887e6a4ef7c..931027ce059 100644
--- a/testing/test_skipping.py
+++ b/testing/test_skipping.py
@@ -236,22 +236,22 @@ def test_func2():
         )
 
     @pytest.mark.parametrize(
-        "test_input,expected",
+       "test_input,expected",
         [
-            ("-rs", ["*unconditional skip*", "*1 skipped*"]),
-            ("-rs --runxfail", ["*unconditional skip*", "*1 skipped*"]),
+            (["-rs"], ["SKIPPED [1] test_sample.py:2: unconditional skip", "*1 skipped*"]),
+            (["-rs", "--runxfail"], ["SKIPPED [1] test_sample.py:2: unconditional skip", "*1 skipped*"]),
         ],
     )
     def test_xfail_run_with_skip_mark(self, testdir, test_input, expected):
-        p = testdir.makepyfile(
-            """
+        testdir.makepyfile(
+            test_sample="""
             import pytest
             @pytest.mark.skip
             def test_skip_location() -> None:
                 assert 0
         """
         )
-        result = testdir.runpytest(p, test_input)
+        result = testdir.runpytest(*test_input)
         result.stdout.fnmatch_lines(expected)
 
     def test_xfail_evalfalse_but_fails(self, testdir):

From ad688f0d1c06d59303750975749b1c53907413c4 Mon Sep 17 00:00:00 2001
From: Arvin Firouzi <427014@student.fontys.nl>
Date: Thu, 9 Jul 2020 20:52:51 +0200
Subject: [PATCH 6/6] fix linting in test_skipping.py

---
 testing/test_skipping.py | 12 +++++++++---
 1 file changed, 9 insertions(+), 3 deletions(-)

diff --git a/testing/test_skipping.py b/testing/test_skipping.py
index 931027ce059..8fceb37aa71 100644
--- a/testing/test_skipping.py
+++ b/testing/test_skipping.py
@@ -236,10 +236,16 @@ def test_func2():
         )
 
     @pytest.mark.parametrize(
-       "test_input,expected",
+        "test_input,expected",
         [
-            (["-rs"], ["SKIPPED [1] test_sample.py:2: unconditional skip", "*1 skipped*"]),
-            (["-rs", "--runxfail"], ["SKIPPED [1] test_sample.py:2: unconditional skip", "*1 skipped*"]),
+            (
+                ["-rs"],
+                ["SKIPPED [1] test_sample.py:2: unconditional skip", "*1 skipped*"],
+            ),
+            (
+                ["-rs", "--runxfail"],
+                ["SKIPPED [1] test_sample.py:2: unconditional skip", "*1 skipped*"],
+            ),
         ],
     )
     def test_xfail_run_with_skip_mark(self, testdir, test_input, expected):
