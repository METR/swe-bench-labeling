{"instance_id": "scikit-learn__scikit-learn-11578", "score": "C", "diff": "diff --git a/sklearn/linear_model/logistic.py b/sklearn/linear_model/logistic.py\nindex e4ea696ce..f3d519ca7 100644\n--- a/sklearn/linear_model/logistic.py\n+++ b/sklearn/linear_model/logistic.py\n@@ -775,7 +775,7 @@ def _log_reg_scoring_path(X, y, train, test, pos_class=None, Cs=10,\n                           scoring=None, fit_intercept=False,\n                           max_iter=100, tol=1e-4, class_weight=None,\n                           verbose=0, solver='lbfgs', penalty='l2',\n-                          dual=False, intercept_scaling=1.,\n+                          dual=False, intercept_scaling=1.0,\n                           multi_class='ovr', random_state=None,\n                           max_squared_sum=None, sample_weight=None):\n     \"\"\"Computes scores across logistic_regression_path\n@@ -922,7 +922,7 @@ def _log_reg_scoring_path(X, y, train, test, pos_class=None, Cs=10,\n         check_input=False, max_squared_sum=max_squared_sum,\n         sample_weight=sample_weight)\n \n-    log_reg = LogisticRegression(fit_intercept=fit_intercept)\n+    log_reg = LogisticRegression(fit_intercept=fit_intercept, multi_class=multi_class, penalty=penalty, dual=dual, tol=tol, C=1.0, intercept_scaling=intercept_scaling, class_weight=class_weight, random_state=random_state, solver=solver, max_iter=max_iter)\n \n     # The score method of Logistic Regression has a classes_ attribute.\n     if multi_class == 'ovr':\n", "gold_standard_diff": "diff --git a/doc/whats_new/v0.20.rst b/doc/whats_new/v0.20.rst\nindex 0df0635d57c75..24f5219d83211 100644\n--- a/doc/whats_new/v0.20.rst\n+++ b/doc/whats_new/v0.20.rst\n@@ -71,6 +71,7 @@ random sampling procedures.\n - :class:`linear_model.PassiveAggressiveRegressor` (bug fix)\n - :class:`linear_model.Perceptron` (bug fix)\n - :class:`ensemble.gradient_boosting.GradientBoostingClassifier` (bug fix affecting feature importances)\n+- :class:`linear_model.LogisticRegressionCV` (bug fix)\n - The v0.19.0 release notes failed to mention a backwards incompatibility with\n   :class:`model_selection.StratifiedKFold` when ``shuffle=True`` due to\n   :issue:`7823`.\n@@ -442,6 +443,11 @@ Classifiers and regressors\n   the ``scoring`` parameter.\n   :issue:`10998` by :user:`Thomas Fan <thomasjpfan>`.\n \n+- Fixed a bug in :class:`linear_model.LogisticRegressionCV` where the 'ovr'\n+  strategy was always used to compute cross-validation scores in the\n+  multiclass setting, even if 'multinomial' was set.\n+  :issue:`8720` by :user:`William de Vazelhes <wdevazelhes>`.\n+\n - Fixed a bug in :class:`linear_model.OrthogonalMatchingPursuit` that was\n   broken when setting ``normalize=False``.\n   :issue:`10071` by `Alexandre Gramfort`_.\ndiff --git a/sklearn/linear_model/logistic.py b/sklearn/linear_model/logistic.py\nindex e4ea696ce7146..a3afb06e449c4 100644\n--- a/sklearn/linear_model/logistic.py\n+++ b/sklearn/linear_model/logistic.py\n@@ -922,7 +922,7 @@ def _log_reg_scoring_path(X, y, train, test, pos_class=None, Cs=10,\n         check_input=False, max_squared_sum=max_squared_sum,\n         sample_weight=sample_weight)\n \n-    log_reg = LogisticRegression(fit_intercept=fit_intercept)\n+    log_reg = LogisticRegression(multi_class=multi_class)\n \n     # The score method of Logistic Regression has a classes_ attribute.\n     if multi_class == 'ovr':\ndiff --git a/sklearn/linear_model/tests/test_logistic.py b/sklearn/linear_model/tests/test_logistic.py\nindex 56be87f71015a..343d8211b1ef4 100644\n--- a/sklearn/linear_model/tests/test_logistic.py\n+++ b/sklearn/linear_model/tests/test_logistic.py\n@@ -6,6 +6,7 @@\n \n from sklearn.datasets import load_iris, make_classification\n from sklearn.metrics import log_loss\n+from sklearn.metrics.scorer import get_scorer\n from sklearn.model_selection import StratifiedKFold\n from sklearn.preprocessing import LabelEncoder\n from sklearn.utils import compute_class_weight\n@@ -29,7 +30,7 @@\n     logistic_regression_path, LogisticRegressionCV,\n     _logistic_loss_and_grad, _logistic_grad_hess,\n     _multinomial_grad_hess, _logistic_loss,\n-)\n+    _log_reg_scoring_path)\n \n X = [[-1, 0], [0, 1], [1, 1]]\n X_sp = sp.csr_matrix(X)\n@@ -492,6 +493,39 @@ def test_logistic_cv():\n     assert_array_equal(scores.shape, (1, 3, 1))\n \n \n+@pytest.mark.parametrize('scoring, multiclass_agg_list',\n+                         [('accuracy', ['']),\n+                          ('precision', ['_macro', '_weighted']),\n+                          # no need to test for micro averaging because it\n+                          # is the same as accuracy for f1, precision,\n+                          # and recall (see https://github.com/\n+                          # scikit-learn/scikit-learn/pull/\n+                          # 11578#discussion_r203250062)\n+                          ('f1', ['_macro', '_weighted']),\n+                          ('neg_log_loss', ['']),\n+                          ('recall', ['_macro', '_weighted'])])\n+def test_logistic_cv_multinomial_score(scoring, multiclass_agg_list):\n+    # test that LogisticRegressionCV uses the right score to compute its\n+    # cross-validation scores when using a multinomial scoring\n+    # see https://github.com/scikit-learn/scikit-learn/issues/8720\n+    X, y = make_classification(n_samples=100, random_state=0, n_classes=3,\n+                               n_informative=6)\n+    train, test = np.arange(80), np.arange(80, 100)\n+    lr = LogisticRegression(C=1., solver='lbfgs', multi_class='multinomial')\n+    # we use lbfgs to support multinomial\n+    params = lr.get_params()\n+    # we store the params to set them further in _log_reg_scoring_path\n+    for key in ['C', 'n_jobs', 'warm_start']:\n+        del params[key]\n+    lr.fit(X[train], y[train])\n+    for averaging in multiclass_agg_list:\n+        scorer = get_scorer(scoring + averaging)\n+        assert_array_almost_equal(\n+            _log_reg_scoring_path(X, y, train, test, Cs=[1.],\n+                                  scoring=scorer, **params)[2][0],\n+            scorer(lr, X[test], y[test]))\n+\n+\n def test_multinomial_logistic_regression_string_inputs():\n     # Test with string labels for LogisticRegression(CV)\n     n_samples, n_features, n_classes = 50, 5, 3\n", "gold_standard_pr_link": "https://github.com/scikit-learn/scikit-learn/pull/11578"}