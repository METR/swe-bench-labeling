{"instance_id": "astropy__astropy-13579", "score": "C", "diff": "diff --git a/astropy/wcs/wcsapi/wrappers/sliced_wcs.py b/astropy/wcs/wcsapi/wrappers/sliced_wcs.py\nindex d7605b078c..61f8b841d6 100644\n--- a/astropy/wcs/wcsapi/wrappers/sliced_wcs.py\n+++ b/astropy/wcs/wcsapi/wrappers/sliced_wcs.py\n@@ -251,7 +251,7 @@ class SlicedLowLevelWCS(BaseWCSWrapper):\n                 iworld_curr += 1\n                 world_arrays_new.append(world_arrays[iworld_curr])\n             else:\n-                world_arrays_new.append(1.)\n+                world_arrays_new.append(self.dropped_world_dimensions['value'][iworld - iworld_curr - 1])\n \n         world_arrays_new = np.broadcast_arrays(*world_arrays_new)\n         pixel_arrays = list(self._wcs.world_to_pixel_values(*world_arrays_new))\ndiff --git a/pyproject.toml b/pyproject.toml\nindex 7a3b85fc92..83f08ed124 100644\n--- a/pyproject.toml\n+++ b/pyproject.toml\n@@ -1,5 +1,5 @@\n [build-system]\n-requires = [\"setuptools\",\n+requires = [\"setuptools==68.0.0\",\n             \"setuptools_scm>=6.2\",\n             \"wheel\",\n             \"cython==0.29.30\",\n", "gold_standard_diff": "From dc851480ee44fc8b23d5e7dadf1c6f177436320d Mon Sep 17 00:00:00 2001\nFrom: Stuart Mumford <stuart@cadair.com>\nDate: Fri, 26 Aug 2022 15:45:33 +0100\nSubject: [PATCH 1/3] Add a failing test\n\n---\n .../wcsapi/wrappers/tests/test_sliced_wcs.py  | 36 +++++++++++++++++++\n 1 file changed, 36 insertions(+)\n\ndiff --git a/astropy/wcs/wcsapi/wrappers/tests/test_sliced_wcs.py b/astropy/wcs/wcsapi/wrappers/tests/test_sliced_wcs.py\nindex a3541149624e..dcc5359827b3 100644\n--- a/astropy/wcs/wcsapi/wrappers/tests/test_sliced_wcs.py\n+++ b/astropy/wcs/wcsapi/wrappers/tests/test_sliced_wcs.py\n@@ -899,3 +899,39 @@ def test_pixel_to_world_values_different_int_types():\n     for int_coord, np64_coord in zip(int_sliced.pixel_to_world_values(*pixel_arrays),\n                                      np64_sliced.pixel_to_world_values(*pixel_arrays)):\n         assert all(int_coord == np64_coord)\n+\n+\n+COUPLED_WCS_HEADER = {\n+    'WCSAXES': 3,\n+    'CRPIX1': (100 + 1)/2,\n+    'CRPIX2': (25 + 1)/2,\n+    'CRPIX3': 1.0,\n+    'PC1_1': 0.0,\n+    'PC1_2': -1.0,\n+    'PC1_3': 0.0,\n+    'PC2_1': 1.0,\n+    'PC2_2': 0.0,\n+    'PC2_3': -1.0,\n+    'CDELT1': 5,\n+    'CDELT2': 5,\n+    'CDELT3': 0.055,\n+    'CUNIT1': 'arcsec',\n+    'CUNIT2': 'arcsec',\n+    'CUNIT3': 'Angstrom',\n+    'CTYPE1': 'HPLN-TAN',\n+    'CTYPE2': 'HPLT-TAN',\n+    'CTYPE3': 'WAVE',\n+    'CRVAL1': 0.0,\n+    'CRVAL2': 0.0,\n+    'CRVAL3': 1.05,\n+\n+}\n+\n+\n+def test_coupled_world_slicing():\n+    fits_wcs = WCS(header=COUPLED_WCS_HEADER)\n+    sl = SlicedLowLevelWCS(fits_wcs, 0)\n+    world = fits_wcs.pixel_to_world_values(0,0,0)\n+    out_pix = sl.world_to_pixel_values(world[0], world[1])\n+\n+    assert np.allclose(out_pix[0], 0)\n\nFrom 4f4c1a3c53ddfb67e5531651a16764e5a38b9dcf Mon Sep 17 00:00:00 2001\nFrom: Stuart Mumford <stuart@cadair.com>\nDate: Fri, 26 Aug 2022 15:50:10 +0100\nSubject: [PATCH 2/3] Fix bug by using the world coordinate corresponding to\n the pixel slice\n\n---\n astropy/wcs/wcsapi/wrappers/sliced_wcs.py | 4 +++-\n 1 file changed, 3 insertions(+), 1 deletion(-)\n\ndiff --git a/astropy/wcs/wcsapi/wrappers/sliced_wcs.py b/astropy/wcs/wcsapi/wrappers/sliced_wcs.py\nindex d7605b078c31..773663f6ec4e 100644\n--- a/astropy/wcs/wcsapi/wrappers/sliced_wcs.py\n+++ b/astropy/wcs/wcsapi/wrappers/sliced_wcs.py\n@@ -243,6 +243,8 @@ def pixel_to_world_values(self, *pixel_arrays):\n         return world_arrays\n \n     def world_to_pixel_values(self, *world_arrays):\n+        sliced_out_world_coords = self._pixel_to_world_values_all(*[0]*len(self._pixel_keep))\n+\n         world_arrays = tuple(map(np.asanyarray, world_arrays))\n         world_arrays_new = []\n         iworld_curr = -1\n@@ -251,7 +253,7 @@ def world_to_pixel_values(self, *world_arrays):\n                 iworld_curr += 1\n                 world_arrays_new.append(world_arrays[iworld_curr])\n             else:\n-                world_arrays_new.append(1.)\n+                world_arrays_new.append(sliced_out_world_coords[iworld])\n \n         world_arrays_new = np.broadcast_arrays(*world_arrays_new)\n         pixel_arrays = list(self._wcs.world_to_pixel_values(*world_arrays_new))\n\nFrom 4dfc5506fb50ba9218853c0c473ead7138a067d4 Mon Sep 17 00:00:00 2001\nFrom: Stuart Mumford <stuart@cadair.com>\nDate: Fri, 26 Aug 2022 16:39:19 +0100\nSubject: [PATCH 3/3] Add changelog\n\n---\n docs/changes/wcs/13579.bugfix.rst | 3 +++\n 1 file changed, 3 insertions(+)\n create mode 100644 docs/changes/wcs/13579.bugfix.rst\n\ndiff --git a/docs/changes/wcs/13579.bugfix.rst b/docs/changes/wcs/13579.bugfix.rst\nnew file mode 100644\nindex 000000000000..588899a09aab\n--- /dev/null\n+++ b/docs/changes/wcs/13579.bugfix.rst\n@@ -0,0 +1,3 @@\n+Fix a bug where ``SlicedLowLevelWCS.world_to_pixel_values`` would break when\n+the result of the transform is dependent on the coordinate of a sliced out\n+pixel.\n", "gold_standard_pr_link": "https://github.com/astropy/astropy/pull/13579"}