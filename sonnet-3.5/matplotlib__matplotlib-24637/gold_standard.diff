From 6f73eb1e7701bf51bbc1fe94d1f35ec7f814bb39 Mon Sep 17 00:00:00 2001
From: saranti <tsarantis@proton.me>
Date: Tue, 6 Dec 2022 14:37:23 +1100
Subject: [PATCH 1/4] Fixes #20044 pass AnnotationBbox to renderer

---
 lib/matplotlib/offsetbox.py | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/lib/matplotlib/offsetbox.py b/lib/matplotlib/offsetbox.py
index 059a6c8ae316..0ccc3149444b 100644
--- a/lib/matplotlib/offsetbox.py
+++ b/lib/matplotlib/offsetbox.py
@@ -1446,6 +1446,7 @@ def draw(self, renderer):
             self._renderer = renderer
         if not self.get_visible() or not self._check_xy(renderer):
             return
+        renderer.open_group(self.__class__.__name__, gid=self.get_gid())
         self.update_positions(renderer)
         if self.arrow_patch is not None:
             if self.arrow_patch.figure is None and self.figure is not None:
@@ -1453,6 +1454,7 @@ def draw(self, renderer):
             self.arrow_patch.draw(renderer)
         self.patch.draw(renderer)
         self.offsetbox.draw(renderer)
+        renderer.close_group(self.__class__.__name__)
         self.stale = False
 
 

From c702a8f8994acaf044690d4dcb4c069da4d9b75f Mon Sep 17 00:00:00 2001
From: saranti <tsarantis@proton.me>
Date: Thu, 8 Dec 2022 22:54:01 +1100
Subject: [PATCH 2/4] Squash past 7 commits - test gid gets passed to the
 renderer

---
 lib/matplotlib/tests/test_backend_svg.py | 35 ++++++++++++++++++++++++
 1 file changed, 35 insertions(+)

diff --git a/lib/matplotlib/tests/test_backend_svg.py b/lib/matplotlib/tests/test_backend_svg.py
index 680efd67379b..454dcc27ff76 100644
--- a/lib/matplotlib/tests/test_backend_svg.py
+++ b/lib/matplotlib/tests/test_backend_svg.py
@@ -15,6 +15,7 @@
 from matplotlib.testing.decorators import check_figures_equal, image_comparison
 from matplotlib.testing._markers import needs_usetex
 from matplotlib import font_manager as fm
+from matplotlib.offsetbox import (OffsetImage, AnnotationBbox)
 
 
 def test_visibility():
@@ -588,3 +589,37 @@ def test_svg_font_string(font_str, include_generic):
 
         assert font_info == f"{size}px {font_str}"
     assert text_count == len(ax.texts)
+
+
+def test_annotationbbox_gid():
+    # Test that object gid appears in the AnnotationBbox
+    # in output svg.
+    fig = plt.figure()
+    ax = fig.add_subplot()
+    arr_img = np.ones((32, 32))
+    xy = (0.3, 0.55)
+
+    imagebox = OffsetImage(arr_img, zoom=0.1)
+    imagebox.image.axes = ax
+
+    ab = AnnotationBbox(imagebox, xy,
+                        xybox=(120., -80.),
+                        xycoords='data',
+                        boxcoords="offset points",
+                        pad=0.5,
+                        arrowprops=dict(
+                            arrowstyle="->",
+                            connectionstyle="angle,angleA=0,angleB=90,rad=3")
+                        )
+    ab.set_gid("a test for issue 20044")
+    ax.add_artist(ab)
+    fig.canvas.draw()
+
+    fd = BytesIO()
+    fig.savefig(fd, format='svg')
+    fd.seek(0)
+    buf = fd.read().decode()
+    fd.close()
+
+    expected = '<g id="a test for issue 20044">'
+    assert expected in buf

From e22733427ac2133bf5c03eb4114ca73eb218e8e7 Mon Sep 17 00:00:00 2001
From: saranti <tsarantis@proton.me>
Date: Sun, 18 Dec 2022 03:12:42 +1100
Subject: [PATCH 3/4] Use a context manager

---
 lib/matplotlib/tests/test_backend_svg.py | 8 +++-----
 1 file changed, 3 insertions(+), 5 deletions(-)

diff --git a/lib/matplotlib/tests/test_backend_svg.py b/lib/matplotlib/tests/test_backend_svg.py
index 454dcc27ff76..bb42290c5d8e 100644
--- a/lib/matplotlib/tests/test_backend_svg.py
+++ b/lib/matplotlib/tests/test_backend_svg.py
@@ -615,11 +615,9 @@ def test_annotationbbox_gid():
     ax.add_artist(ab)
     fig.canvas.draw()
 
-    fd = BytesIO()
-    fig.savefig(fd, format='svg')
-    fd.seek(0)
-    buf = fd.read().decode()
-    fd.close()
+    with BytesIO() as fd:
+        fig.savefig(fd, format='svg')
+        buf = fd.getvalue().decode('utf-8')
 
     expected = '<g id="a test for issue 20044">'
     assert expected in buf

From a09f78aea02d345da6467992a601331cfdb1a9f0 Mon Sep 17 00:00:00 2001
From: saranti <tsarantis@proton.me>
Date: Thu, 22 Dec 2022 18:33:54 +1100
Subject: [PATCH 4/4] Remove line

---
 lib/matplotlib/tests/test_backend_svg.py | 1 -
 1 file changed, 1 deletion(-)

diff --git a/lib/matplotlib/tests/test_backend_svg.py b/lib/matplotlib/tests/test_backend_svg.py
index bb42290c5d8e..c0fe8549c2f3 100644
--- a/lib/matplotlib/tests/test_backend_svg.py
+++ b/lib/matplotlib/tests/test_backend_svg.py
@@ -613,7 +613,6 @@ def test_annotationbbox_gid():
                         )
     ab.set_gid("a test for issue 20044")
     ax.add_artist(ab)
-    fig.canvas.draw()
 
     with BytesIO() as fd:
         fig.savefig(fd, format='svg')
