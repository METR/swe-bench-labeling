{"instance_id": "django__django-13279", "score": "C", "diff": "diff --git a/django/contrib/sessions/backends/base.py b/django/contrib/sessions/backends/base.py\nindex b5453160a5..a2d3ba5215 100644\n--- a/django/contrib/sessions/backends/base.py\n+++ b/django/contrib/sessions/backends/base.py\n@@ -108,12 +108,25 @@ class SessionBase:\n \n     def encode(self, session_dict):\n         \"Return the given session dictionary serialized and encoded as a string.\"\n-        return signing.dumps(\n-            session_dict, salt=self.key_salt, serializer=self.serializer,\n-            compress=True,\n-        )\n+        if settings.DEFAULT_HASHING_ALGORITHM == 'sha1':\n+            # Use legacy encoding\n+            serialized = self.serializer().dumps(session_dict)\n+            hash = self._hash(serialized)\n+            return base64.b64encode(hash.encode() + b':' + serialized).decode('ascii')\n+        else:\n+            # Use new encoding\n+            return signing.dumps(\n+                session_dict, salt=self.key_salt, serializer=self.serializer,\n+                compress=True,\n+            )\n \n     def decode(self, session_data):\n+        \"\"\"\n+        Decode the given session data.\n+        This method attempts to decode using the new format first.\n+        If that fails, it falls back to the legacy format.\n+        This allows for backward compatibility during the transition to Django 3.1.\n+        \"\"\"\n         try:\n             return signing.loads(session_data, salt=self.key_salt, serializer=self.serializer)\n         # RemovedInDjango40Warning: when the deprecation ends, handle here\n", "gold_standard_diff": "From faed7ef8b76d7798bce15908d80c90aea6ce554b Mon Sep 17 00:00:00 2001\nFrom: Mariusz Felisiak <felisiak.mariusz@gmail.com>\nDate: Fri, 7 Aug 2020 07:05:57 +0200\nSubject: [PATCH] Fixed #31864 -- Fixed encoding session data during transition\n to Django 3.1.\nMIME-Version: 1.0\nContent-Type: text/plain; charset=UTF-8\nContent-Transfer-Encoding: 8bit\n\nThanks \u05d0\u05d5\u05e8\u05d9 for the report.\n---\n django/contrib/sessions/backends/base.py |  9 +++++++++\n docs/releases/3.1.1.txt                  |  3 +++\n tests/sessions_tests/tests.py            | 19 +++++++++++++------\n 3 files changed, 25 insertions(+), 6 deletions(-)\n\ndiff --git a/django/contrib/sessions/backends/base.py b/django/contrib/sessions/backends/base.py\nindex b5453160a5a9..187e14b1b734 100644\n--- a/django/contrib/sessions/backends/base.py\n+++ b/django/contrib/sessions/backends/base.py\n@@ -108,6 +108,9 @@ def _hash(self, value):\n \n     def encode(self, session_dict):\n         \"Return the given session dictionary serialized and encoded as a string.\"\n+        # RemovedInDjango40Warning: DEFAULT_HASHING_ALGORITHM will be removed.\n+        if settings.DEFAULT_HASHING_ALGORITHM == 'sha1':\n+            return self._legacy_encode(session_dict)\n         return signing.dumps(\n             session_dict, salt=self.key_salt, serializer=self.serializer,\n             compress=True,\n@@ -121,6 +124,12 @@ def decode(self, session_data):\n         except Exception:\n             return self._legacy_decode(session_data)\n \n+    def _legacy_encode(self, session_dict):\n+        # RemovedInDjango40Warning.\n+        serialized = self.serializer().dumps(session_dict)\n+        hash = self._hash(serialized)\n+        return base64.b64encode(hash.encode() + b':' + serialized).decode('ascii')\n+\n     def _legacy_decode(self, session_data):\n         # RemovedInDjango40Warning: pre-Django 3.1 format will be invalid.\n         encoded_data = base64.b64decode(session_data.encode('ascii'))\ndiff --git a/docs/releases/3.1.1.txt b/docs/releases/3.1.1.txt\nindex 516d47cd03d0..c8201d4e4182 100644\n--- a/docs/releases/3.1.1.txt\n+++ b/docs/releases/3.1.1.txt\n@@ -14,3 +14,6 @@ Bugfixes\n \n * Fixed wrapping of long model names in the admin's navigation sidebar\n   (:ticket:`31854`).\n+\n+* Fixed encoding session data while upgrading multiple instances of the same\n+  project to Django 3.1 (:ticket:`31864`).\ndiff --git a/tests/sessions_tests/tests.py b/tests/sessions_tests/tests.py\nindex 248dae82aa4a..e7615d0f1114 100644\n--- a/tests/sessions_tests/tests.py\n+++ b/tests/sessions_tests/tests.py\n@@ -31,9 +31,11 @@\n from django.core.exceptions import ImproperlyConfigured, SuspiciousOperation\n from django.http import HttpResponse\n from django.test import (\n-    RequestFactory, TestCase, ignore_warnings, override_settings,\n+    RequestFactory, SimpleTestCase, TestCase, ignore_warnings,\n+    override_settings,\n )\n from django.utils import timezone\n+from django.utils.deprecation import RemovedInDjango40Warning\n \n from .models import SessionStore as CustomDatabaseSession\n \n@@ -323,6 +325,13 @@ def test_decode_legacy(self):\n             {'a test key': 'a test value'},\n         )\n \n+    @ignore_warnings(category=RemovedInDjango40Warning)\n+    def test_default_hashing_algorith_legacy_decode(self):\n+        with self.settings(DEFAULT_HASHING_ALGORITHM='sha1'):\n+            data = {'a test key': 'a test value'}\n+            encoded = self.session.encode(data)\n+            self.assertEqual(self.session._legacy_decode(encoded), data)\n+\n     def test_decode_failure_logged_to_security(self):\n         bad_encode = base64.b64encode(b'flaskdj:alkdjf').decode('ascii')\n         with self.assertLogs('django.security.SuspiciousSession', 'WARNING') as cm:\n@@ -526,8 +535,7 @@ class CacheDBSessionWithTimeZoneTests(CacheDBSessionTests):\n     pass\n \n \n-# Don't need DB flushing for these tests, so can use unittest.TestCase as base class\n-class FileSessionTests(SessionTestsMixin, unittest.TestCase):\n+class FileSessionTests(SessionTestsMixin, SimpleTestCase):\n \n     backend = FileSession\n \n@@ -620,7 +628,7 @@ def mkdtemp(self):\n         return Path(tmp_dir)\n \n \n-class CacheSessionTests(SessionTestsMixin, unittest.TestCase):\n+class CacheSessionTests(SessionTestsMixin, SimpleTestCase):\n \n     backend = CacheSession\n \n@@ -854,8 +862,7 @@ def response_set_session(request):\n         self.assertEqual(response['Vary'], 'Cookie')\n \n \n-# Don't need DB flushing for these tests, so can use unittest.TestCase as base class\n-class CookieSessionTests(SessionTestsMixin, unittest.TestCase):\n+class CookieSessionTests(SessionTestsMixin, SimpleTestCase):\n \n     backend = CookieSession\n \n", "gold_standard_pr_link": "https://github.com/django/django/pull/13279"}