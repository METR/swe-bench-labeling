{"instance_id": "sphinx-doc__sphinx-9711", "score": "C", "diff": "diff --git a/setup.py b/setup.py\nindex 3dbc8746b..31bd48c0a 100644\n--- a/setup.py\n+++ b/setup.py\n@@ -15,22 +15,22 @@ if sys.version_info < (3, 6):\n     sys.exit(1)\n \n install_requires = [\n-    'sphinxcontrib-applehelp',\n-    'sphinxcontrib-devhelp',\n+    'sphinxcontrib-applehelp<=1.0.7',\n+    'sphinxcontrib-devhelp<=1.0.5',\n     'sphinxcontrib-jsmath',\n-    'sphinxcontrib-htmlhelp>=2.0.0',\n-    'sphinxcontrib-serializinghtml>=1.1.5',\n-    'sphinxcontrib-qthelp',\n-    'Jinja2>=2.3',\n+    'sphinxcontrib-htmlhelp>=2.0.0,<=2.0.4',\n+    'sphinxcontrib-serializinghtml>=1.1.5,<=1.1.9',\n+    'sphinxcontrib-qthelp<=1.0.6',\n+    'Jinja2<3.0',\n     'Pygments>=2.0',\n     'docutils>=0.14,<0.18',\n     'snowballstemmer>=1.1',\n     'babel>=1.3',\n-    'alabaster>=0.7,<0.8',\n+    'alabaster>=0.7,<0.7.12',\n     'imagesize',\n     'requests>=2.5.0',\n     'setuptools',\n-    'packaging',\n+    'packaging', 'markupsafe<=2.0.1',\n ]\n \n extras_require = {\ndiff --git a/sphinx/extension.py b/sphinx/extension.py\nindex 7ec6c8518..dbc232aa7 100644\n--- a/sphinx/extension.py\n+++ b/sphinx/extension.py\n@@ -10,6 +10,7 @@\n \n from typing import TYPE_CHECKING, Any, Dict\n \n+from packaging.version import Version\n from sphinx.config import Config\n from sphinx.errors import VersionRequirementError\n from sphinx.locale import __\n@@ -51,7 +52,12 @@ def verify_needs_extensions(app: \"Sphinx\", config: Config) -> None:\n                               'but it is not loaded.'), extname)\n             continue\n \n-        if extension.version == 'unknown version' or reqversion > extension.version:\n+        if extension.version == 'unknown version':\n+            logger.warning(__('The version of %s extension is unknown. '\n+                              'Assuming it does not meet the requirement.'), extname)\n+            continue\n+\n+        if Version(reqversion) > Version(extension.version):\n             raise VersionRequirementError(__('This project needs the extension %s at least in '\n                                              'version %s and therefore cannot be built with '\n                                              'the loaded version (%s).') %\ndiff --git a/tox.ini b/tox.ini\nindex 00c8e13bd..11d3352df 100644\n--- a/tox.ini\n+++ b/tox.ini\n@@ -22,14 +22,14 @@ deps =\n     du15: docutils==0.15.*\n     du16: docutils==0.16.*\n     du17: docutils==0.17.*\n-    py311: git+https://github.com/pytest-dev/py\n+    py311: git+https://github.com/pytest -rA-dev/py\n extras =\n     test\n setenv =\n     PYTHONWARNINGS = all,ignore::ImportWarning:importlib._bootstrap_external,ignore::DeprecationWarning:site,ignore::DeprecationWarning:distutils,ignore::DeprecationWarning:pip._vendor.packaging.version\n     PYTEST_ADDOPTS = {env:PYTEST_ADDOPTS:} --color yes\n commands=\n-    python -X dev -m pytest --durations 25 {posargs}\n+    python -X dev -m pytest -rA --durations 25 {posargs}\n \n [testenv:du-latest]\n commands =\n", "gold_standard_diff": "From 3c9e53852dc70a9402690b01b96fc5d5c864fe84 Mon Sep 17 00:00:00 2001\nFrom: Takeshi KOMIYA <i.tkomiya@gmail.com>\nDate: Thu, 7 Oct 2021 00:07:17 +0900\nSubject: [PATCH] Fix #9708: needs_extension failed to check double-digit\n version correctly\n\n---\n CHANGES                 |  1 +\n sphinx/extension.py     | 15 ++++++++++++++-\n tests/test_extension.py | 31 +++++++++++++++++++++++++++++++\n 3 files changed, 46 insertions(+), 1 deletion(-)\n create mode 100644 tests/test_extension.py\n\ndiff --git a/CHANGES b/CHANGES\nindex d2d8b0985a5..2ab2bc27f2c 100644\n--- a/CHANGES\n+++ b/CHANGES\n@@ -59,6 +59,7 @@ Bugs fixed\n * #9649: HTML search: when objects have the same name but in different domains,\n   return all of them as result instead of just one.\n * #9678: linkcheck: file extension was shown twice in warnings\n+* #9708: needs_extension failed to check double-digit version correctly\n \n Testing\n --------\ndiff --git a/sphinx/extension.py b/sphinx/extension.py\nindex 7ec6c8518c3..34bf7763ad7 100644\n--- a/sphinx/extension.py\n+++ b/sphinx/extension.py\n@@ -10,6 +10,8 @@\n \n from typing import TYPE_CHECKING, Any, Dict\n \n+from packaging.version import InvalidVersion, Version\n+\n from sphinx.config import Config\n from sphinx.errors import VersionRequirementError\n from sphinx.locale import __\n@@ -51,7 +53,18 @@ def verify_needs_extensions(app: \"Sphinx\", config: Config) -> None:\n                               'but it is not loaded.'), extname)\n             continue\n \n-        if extension.version == 'unknown version' or reqversion > extension.version:\n+        fulfilled = True\n+        if extension.version == 'unknown version':\n+            fulfilled = False\n+        else:\n+            try:\n+                if Version(reqversion) > Version(extension.version):\n+                    fulfilled = False\n+            except InvalidVersion:\n+                if reqversion > extension.version:\n+                    fulfilled = False\n+\n+        if not fulfilled:\n             raise VersionRequirementError(__('This project needs the extension %s at least in '\n                                              'version %s and therefore cannot be built with '\n                                              'the loaded version (%s).') %\ndiff --git a/tests/test_extension.py b/tests/test_extension.py\nnew file mode 100644\nindex 00000000000..db9f4e48761\n--- /dev/null\n+++ b/tests/test_extension.py\n@@ -0,0 +1,31 @@\n+\"\"\"\n+    test_extension\n+    ~~~~~~~~~~~~~~\n+\n+    Test sphinx.extesion module.\n+\n+    :copyright: Copyright 2007-2021 by the Sphinx team, see AUTHORS.\n+    :license: BSD, see LICENSE for details.\n+\"\"\"\n+\n+import pytest\n+\n+from sphinx.errors import VersionRequirementError\n+from sphinx.extension import Extension, verify_needs_extensions\n+\n+\n+def test_needs_extensions(app):\n+    # empty needs_extensions\n+    assert app.config.needs_extensions == {}\n+    verify_needs_extensions(app, app.config)\n+\n+    # needs_extensions fulfilled\n+    app.config.needs_extensions = {'test.extension': '3.9'}\n+    app.extensions['test.extension'] = Extension('test.extension', 'test.extension', version='3.10')\n+    verify_needs_extensions(app, app.config)\n+\n+    # needs_extensions not fulfilled\n+    app.config.needs_extensions = {'test.extension': '3.11'}\n+    app.extensions['test.extension'] = Extension('test.extension', 'test.extension', version='3.10')\n+    with pytest.raises(VersionRequirementError):\n+        verify_needs_extensions(app, app.config)\n", "gold_standard_pr_link": "https://github.com/sphinx-doc/sphinx/pull/9711"}