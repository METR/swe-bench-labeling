{"instance_id": "pydata__xarray-4075", "score": "C", "diff": "diff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 996d2e4c..a9feac10 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -141,8 +141,14 @@ class Weighted:\n \n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n-\n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        \n+        # Convert weights to numeric if they are boolean to ensure correct sum\n+        # when mask is also boolean (e.g., when weights are boolean)\n+        weights = self.weights\n+        if weights.dtype == bool:\n+            weights = weights.astype(int)\n+\n+        sum_of_weights = self._reduce(mask, weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\ndiff --git a/xarray/tests/test_weighted.py b/xarray/tests/test_weighted.py\nindex 24531215..e1b5d32b 100644\n--- a/xarray/tests/test_weighted.py\n+++ b/xarray/tests/test_weighted.py\n@@ -158,6 +158,64 @@ def test_weighted_mean_nan(weights, expected, skipna):\n     assert_equal(expected, result)\n \n \n+def test_weighted_mean_boolean_weights():\n+    # Test case from issue #4349\n+    dta = DataArray([1., 1., 1.])\n+    wgt = DataArray(np.array([1, 1, 0], dtype=bool))\n+    result = dta.weighted(wgt).mean()\n+    expected = DataArray(1.0)\n+    assert_equal(result, expected)\n+\n+\n+def test_weighted_sum_boolean_weights():\n+    dta = DataArray([1., 2., 3.])\n+    wgt = DataArray(np.array([True, False, True]))\n+    result = dta.weighted(wgt).sum()\n+    expected = DataArray(4.0)\n+    assert_equal(result, expected)\n+\n+\n+def test_weighted_sum_of_weights_boolean():\n+    dta = DataArray([1., 2., 3.])\n+    wgt = DataArray(np.array([True, True, False]))\n+    result = dta.weighted(wgt).sum_of_weights()\n+    expected = DataArray(2.0)\n+    assert_equal(result, expected)\n+\n+\n+@pytest.mark.parametrize(\"skipna\", [True, False])\n+def test_weighted_mean_boolean_weights_with_nan(skipna):\n+    dta = DataArray([1., np.nan, 3.])\n+    wgt = DataArray(np.array([True, True, False]))\n+    result = dta.weighted(wgt).mean(skipna=skipna)\n+    if skipna:\n+        expected = DataArray(1.0)\n+    else:\n+        expected = DataArray(np.nan)\n+    assert_equal(result, expected)\n+\n+\n+def test_weighted_operations_boolean_multidim():\n+    # Test multi-dimensional case with boolean weights\n+    dta = DataArray([[1., 2.], [3., 4.]], dims=['x', 'y'])\n+    wgt = DataArray([[True, False], [True, True]], dims=['x', 'y'])\n+    \n+    # Test mean over all dimensions\n+    result_mean = dta.weighted(wgt).mean()\n+    expected_mean = DataArray((1 + 3 + 4) / 3.0)\n+    assert_allclose(result_mean, expected_mean)\n+    \n+    # Test mean over one dimension\n+    result_mean_x = dta.weighted(wgt).mean(dim='x')\n+    expected_mean_x = DataArray([2.0, 4.0], dims=['y'])\n+    assert_allclose(result_mean_x, expected_mean_x)\n+    \n+    # Test sum\n+    result_sum = dta.weighted(wgt).sum()\n+    expected_sum = DataArray(8.0)\n+    assert_equal(result_sum, expected_sum)\n+\n+\n def expected_weighted(da, weights, dim, skipna, operation):\n     \"\"\"\n     Generate expected result using ``*`` and ``sum``. This is checked against\n", "gold_standard_diff": "diff --git a/doc/whats-new.rst b/doc/whats-new.rst\nindex 447aaf5b0bf..a4602c1edad 100644\n--- a/doc/whats-new.rst\n+++ b/doc/whats-new.rst\n@@ -119,6 +119,8 @@ Bug fixes\n - Fix bug in time parsing failing to fall back to cftime. This was causing time\n   variables with a time unit of `'msecs'` to fail to parse. (:pull:`3998`)\n   By `Ryan May <https://github.com/dopplershift>`_.\n+- Fix weighted mean when passing boolean weights (:issue:`4074`).\n+  By `Mathias Hauser <https://github.com/mathause>`_.\n - Fix html repr in untrusted notebooks: fallback to plain text repr. (:pull:`4053`)\n   By `Benoit Bovy <https://github.com/benbovy>`_.\n \n@@ -186,7 +188,7 @@ New Features\n \n - Weighted array reductions are now supported via the new :py:meth:`DataArray.weighted`\n   and :py:meth:`Dataset.weighted` methods. See :ref:`comput.weighted`. (:issue:`422`, :pull:`2922`).\n-  By `Mathias Hauser <https://github.com/mathause>`_\n+  By `Mathias Hauser <https://github.com/mathause>`_.\n - The new jupyter notebook repr (``Dataset._repr_html_`` and\n   ``DataArray._repr_html_``) (introduced in 0.14.1) is now on by default. To\n   disable, use ``xarray.set_options(display_style=\"text\")``.\ndiff --git a/xarray/core/weighted.py b/xarray/core/weighted.py\nindex 996d2e4c43e..21ed06ea85f 100644\n--- a/xarray/core/weighted.py\n+++ b/xarray/core/weighted.py\n@@ -142,7 +142,14 @@ def _sum_of_weights(\n         # we need to mask data values that are nan; else the weights are wrong\n         mask = da.notnull()\n \n-        sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n+        # bool -> int, because ``xr.dot([True, True], [True, True])`` -> True\n+        # (and not 2); GH4074\n+        if self.weights.dtype == bool:\n+            sum_of_weights = self._reduce(\n+                mask, self.weights.astype(int), dim=dim, skipna=False\n+            )\n+        else:\n+            sum_of_weights = self._reduce(mask, self.weights, dim=dim, skipna=False)\n \n         # 0-weights are not valid\n         valid_weights = sum_of_weights != 0.0\ndiff --git a/xarray/tests/test_weighted.py b/xarray/tests/test_weighted.py\nindex 24531215dfb..1bf685cc95d 100644\n--- a/xarray/tests/test_weighted.py\n+++ b/xarray/tests/test_weighted.py\n@@ -59,6 +59,18 @@ def test_weighted_sum_of_weights_nan(weights, expected):\n     assert_equal(expected, result)\n \n \n+def test_weighted_sum_of_weights_bool():\n+    # https://github.com/pydata/xarray/issues/4074\n+\n+    da = DataArray([1, 2])\n+    weights = DataArray([True, True])\n+    result = da.weighted(weights).sum_of_weights()\n+\n+    expected = DataArray(2)\n+\n+    assert_equal(expected, result)\n+\n+\n @pytest.mark.parametrize(\"da\", ([1.0, 2], [1, np.nan], [np.nan, np.nan]))\n @pytest.mark.parametrize(\"factor\", [0, 1, 3.14])\n @pytest.mark.parametrize(\"skipna\", (True, False))\n@@ -158,6 +170,17 @@ def test_weighted_mean_nan(weights, expected, skipna):\n     assert_equal(expected, result)\n \n \n+def test_weighted_mean_bool():\n+    # https://github.com/pydata/xarray/issues/4074\n+    da = DataArray([1, 1])\n+    weights = DataArray([True, True])\n+    expected = DataArray(1)\n+\n+    result = da.weighted(weights).mean()\n+\n+    assert_equal(expected, result)\n+\n+\n def expected_weighted(da, weights, dim, skipna, operation):\n     \"\"\"\n     Generate expected result using ``*`` and ``sum``. This is checked against\n", "gold_standard_pr_link": "https://github.com/pydata/xarray/pull/4075"}