From 069729efbbb7f31dfb2d32496a4460c920e73511 Mon Sep 17 00:00:00 2001
From: Stuart Mumford <stuart@cadair.com>
Date: Thu, 3 Mar 2022 15:13:40 +0000
Subject: [PATCH 1/3] Attempt to fix astropy/astropy#12906

---
 astropy/modeling/separable.py            | 2 +-
 astropy/modeling/tests/test_separable.py | 9 ++++++++-
 2 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/astropy/modeling/separable.py b/astropy/modeling/separable.py
index a308e27297d1..45bea360859c 100644
--- a/astropy/modeling/separable.py
+++ b/astropy/modeling/separable.py
@@ -242,7 +242,7 @@ def _cstack(left, right):
         cright = _coord_matrix(right, 'right', noutp)
     else:
         cright = np.zeros((noutp, right.shape[1]))
-        cright[-right.shape[0]:, -right.shape[1]:] = 1
+        cright[-right.shape[0]:, -right.shape[1]:] = right
 
     return np.hstack([cleft, cright])
 
diff --git a/astropy/modeling/tests/test_separable.py b/astropy/modeling/tests/test_separable.py
index 8dfe5c862665..ffb9351413a0 100644
--- a/astropy/modeling/tests/test_separable.py
+++ b/astropy/modeling/tests/test_separable.py
@@ -52,7 +52,14 @@
     'cm7': (map2 | p2 & sh1,
             (np.array([False, True]),
              np.array([[True, False], [False, True]]))
-            )
+            ),
+    'cm8': (rot & (sh1 & sh2),
+            (np.array([False, False, True, True]),
+             np.array([[True, True, False, False],
+                       [True, True, False, False],
+                       [False, False, True, False],
+                       [False, False, False, True]]))
+            ),
 }
 
 

From d05766f6355b9820868e3fb1e34e38e2c5c023ea Mon Sep 17 00:00:00 2001
From: Stuart Mumford <stuart@cadair.com>
Date: Fri, 4 Mar 2022 14:14:32 +0000
Subject: [PATCH 2/3] More tests

---
 astropy/modeling/tests/test_separable.py | 24 +++++++++++++++++-------
 1 file changed, 17 insertions(+), 7 deletions(-)

diff --git a/astropy/modeling/tests/test_separable.py b/astropy/modeling/tests/test_separable.py
index ffb9351413a0..024b239508f5 100644
--- a/astropy/modeling/tests/test_separable.py
+++ b/astropy/modeling/tests/test_separable.py
@@ -28,6 +28,13 @@
 p1 = models.Polynomial1D(1, name='p1')
 
 
+cm_4d_expected = (np.array([False, False, True, True]),
+                  np.array([[True,  True,  False, False],
+                            [True,  True,  False, False],
+                            [False, False, True,  False],
+                            [False, False, False, True]]))
+
+
 compound_models = {
     'cm1': (map3 & sh1 | rot & sh1 | sh1 & sh2 & sh1,
             (np.array([False, False, True]),
@@ -53,13 +60,16 @@
             (np.array([False, True]),
              np.array([[True, False], [False, True]]))
             ),
-    'cm8': (rot & (sh1 & sh2),
-            (np.array([False, False, True, True]),
-             np.array([[True, True, False, False],
-                       [True, True, False, False],
-                       [False, False, True, False],
-                       [False, False, False, True]]))
-            ),
+    'cm8': (rot & (sh1 & sh2), cm_4d_expected),
+    'cm9': (rot & sh1 & sh2, cm_4d_expected),
+    'cm10': ((rot & sh1) & sh2, cm_4d_expected),
+    'cm11': (rot & sh1 & (scl1 & scl2),
+             (np.array([False, False, True, True, True]),
+              np.array([[True,  True,  False, False, False],
+                        [True,  True,  False, False, False],
+                        [False, False, True,  False, False],
+                        [False, False, False, True,  False],
+                        [False, False, False, False, True]]))),
 }
 
 

From efedd57cb088b6ca73f9540a3c6185ad7046c926 Mon Sep 17 00:00:00 2001
From: Stuart Mumford <stuart@cadair.com>
Date: Fri, 4 Mar 2022 14:15:54 +0000
Subject: [PATCH 3/3] Add changelog

---
 docs/changes/modeling/12907.bugfix.rst | 1 +
 1 file changed, 1 insertion(+)
 create mode 100644 docs/changes/modeling/12907.bugfix.rst

diff --git a/docs/changes/modeling/12907.bugfix.rst b/docs/changes/modeling/12907.bugfix.rst
new file mode 100644
index 000000000000..a5d8c14706c3
--- /dev/null
+++ b/docs/changes/modeling/12907.bugfix.rst
@@ -0,0 +1 @@
+Fix computation of the separability of a ``CompoundModel`` where another ``CompoundModel`` is on the right hand side of the ``&`` operator.
