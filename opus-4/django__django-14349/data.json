{"instance_id": "django__django-14349", "score": "C", "diff": "diff --git a/django/core/validators.py b/django/core/validators.py\nindex a385819510..2884037d29 100644\n--- a/django/core/validators.py\n+++ b/django/core/validators.py\n@@ -101,6 +101,12 @@ class URLValidator(RegexValidator):\n     def __call__(self, value):\n         if not isinstance(value, str):\n             raise ValidationError(self.message, code=self.code, params={'value': value})\n+        \n+        # Check for control characters that urlsplit might strip (bpo-43882)\n+        # to ensure consistent behavior across Python versions\n+        if '\\n' in value or '\\r' in value or '\\t' in value:\n+            raise ValidationError(self.message, code=self.code, params={'value': value})\n+            \n         # Check if the scheme is valid.\n         scheme = value.split('://')[0].lower()\n         if scheme not in self.schemes:\ndiff --git a/test_urlvalidator_fix.py b/test_urlvalidator_fix.py\nnew file mode 100644\nindex 0000000000..921c61bf39\n--- /dev/null\n+++ b/test_urlvalidator_fix.py\n@@ -0,0 +1,41 @@\n+#!/usr/bin/env python\n+\"\"\"\n+Test script to verify URLValidator behavior with control characters\n+across different Python versions.\n+\"\"\"\n+import sys\n+import django\n+from django.conf import settings\n+\n+# Configure Django\n+settings.configure(\n+    USE_I18N=True,\n+    SECRET_KEY='test-secret-key',\n+)\n+django.setup()\n+\n+from django.core.validators import URLValidator\n+from django.core.exceptions import ValidationError\n+\n+# Test URLs with control characters\n+test_urls = [\n+    ('http://www.djangoproject.com/\\n', 'URL with newline'),\n+    ('http://[::ffff:192.9.5.5]\\n', 'IPv6 URL with newline'),\n+    ('http://example.com/\\r', 'URL with carriage return'),\n+    ('http://example.com/\\t', 'URL with tab'),\n+    ('http://example.com/', 'Valid URL without control chars'),\n+]\n+\n+print(f\"Python version: {sys.version}\")\n+print(\"-\" * 60)\n+\n+for url, description in test_urls:\n+    try:\n+        URLValidator()(url)\n+        result = \"VALID (no exception)\"\n+    except ValidationError:\n+        result = \"INVALID (ValidationError raised)\"\n+    \n+    print(f\"{description:<35} {repr(url):<30} {result}\")\n+\n+print(\"\\nAll tests completed successfully!\")\n", "gold_standard_diff": "From cfe6b8bdd63890e4bb6482a806f3a9065045291e Mon Sep 17 00:00:00 2001\nFrom: Mariusz Felisiak <felisiak.mariusz@gmail.com>\nDate: Tue, 4 May 2021 20:50:12 +0200\nSubject: [PATCH] Fixed #32713, Fixed CVE-2021-32052 -- Prevented newlines and\n tabs from being accepted in URLValidator on Python 3.9.5+.\n\nIn Python 3.9.5+ urllib.parse() automatically removes ASCII newlines\nand tabs from URLs [1, 2]. Unfortunately it created an issue in\nthe URLValidator. URLValidator uses urllib.urlsplit() and\nurllib.urlunsplit() for creating a URL variant with Punycode which no\nlonger contains newlines and tabs in Python 3.9.5+. As a consequence,\nthe regular expression matched the URL (without unsafe characters) and\nthe source value (with unsafe characters) was considered valid.\n\n[1] https://bugs.python.org/issue43882 and\n[2] https://github.com/python/cpython/commit/76cd81d60310d65d01f9d7b48a8985d8ab89c8b4\n---\n django/core/validators.py |  3 +++\n docs/releases/2.2.22.txt  | 22 ++++++++++++++++++++++\n docs/releases/3.1.10.txt  | 22 ++++++++++++++++++++++\n docs/releases/3.2.2.txt   | 19 +++++++++++++++++--\n docs/releases/index.txt   |  2 ++\n tests/validators/tests.py |  8 +++++++-\n 6 files changed, 73 insertions(+), 3 deletions(-)\n create mode 100644 docs/releases/2.2.22.txt\n create mode 100644 docs/releases/3.1.10.txt\n\ndiff --git a/django/core/validators.py b/django/core/validators.py\nindex a385819510d9..f9abec602cb1 100644\n--- a/django/core/validators.py\n+++ b/django/core/validators.py\n@@ -92,6 +92,7 @@ class URLValidator(RegexValidator):\n         r'\\Z', re.IGNORECASE)\n     message = _('Enter a valid URL.')\n     schemes = ['http', 'https', 'ftp', 'ftps']\n+    unsafe_chars = frozenset('\\t\\r\\n')\n \n     def __init__(self, schemes=None, **kwargs):\n         super().__init__(**kwargs)\n@@ -101,6 +102,8 @@ def __init__(self, schemes=None, **kwargs):\n     def __call__(self, value):\n         if not isinstance(value, str):\n             raise ValidationError(self.message, code=self.code, params={'value': value})\n+        if self.unsafe_chars.intersection(value):\n+            raise ValidationError(self.message, code=self.code, params={'value': value})\n         # Check if the scheme is valid.\n         scheme = value.split('://')[0].lower()\n         if scheme not in self.schemes:\ndiff --git a/docs/releases/2.2.22.txt b/docs/releases/2.2.22.txt\nnew file mode 100644\nindex 000000000000..6808a267afeb\n--- /dev/null\n+++ b/docs/releases/2.2.22.txt\n@@ -0,0 +1,22 @@\n+===========================\n+Django 2.2.22 release notes\n+===========================\n+\n+*May 6, 2021*\n+\n+Django 2.2.22 fixes a security issue in 2.2.21.\n+\n+CVE-2021-32052: Header injection possibility since ``URLValidator`` accepted newlines in input on Python 3.9.5+\n+===============================================================================================================\n+\n+On Python 3.9.5+, :class:`~django.core.validators.URLValidator` didn't prohibit\n+newlines and tabs. If you used values with newlines in HTTP response, you could\n+suffer from header injection attacks. Django itself wasn't vulnerable because\n+:class:`~django.http.HttpResponse` prohibits newlines in HTTP headers.\n+\n+Moreover, the ``URLField`` form field which uses ``URLValidator`` silently\n+removes newlines and tabs on Python 3.9.5+, so the possibility of newlines\n+entering your data only existed if you are using this validator outside of the\n+form fields.\n+\n+This issue was introduced by the :bpo:`43882` fix.\ndiff --git a/docs/releases/3.1.10.txt b/docs/releases/3.1.10.txt\nnew file mode 100644\nindex 000000000000..e9a8fcc2d81b\n--- /dev/null\n+++ b/docs/releases/3.1.10.txt\n@@ -0,0 +1,22 @@\n+===========================\n+Django 3.1.10 release notes\n+===========================\n+\n+*May 6, 2021*\n+\n+Django 3.1.10 fixes a security issue in 3.1.9.\n+\n+CVE-2021-32052: Header injection possibility since ``URLValidator`` accepted newlines in input on Python 3.9.5+\n+===============================================================================================================\n+\n+On Python 3.9.5+, :class:`~django.core.validators.URLValidator` didn't prohibit\n+newlines and tabs. If you used values with newlines in HTTP response, you could\n+suffer from header injection attacks. Django itself wasn't vulnerable because\n+:class:`~django.http.HttpResponse` prohibits newlines in HTTP headers.\n+\n+Moreover, the ``URLField`` form field which uses ``URLValidator`` silently\n+removes newlines and tabs on Python 3.9.5+, so the possibility of newlines\n+entering your data only existed if you are using this validator outside of the\n+form fields.\n+\n+This issue was introduced by the :bpo:`43882` fix.\ndiff --git a/docs/releases/3.2.2.txt b/docs/releases/3.2.2.txt\nindex d47da08d6c15..a899bc6e2994 100644\n--- a/docs/releases/3.2.2.txt\n+++ b/docs/releases/3.2.2.txt\n@@ -2,9 +2,24 @@\n Django 3.2.2 release notes\n ==========================\n \n-*Expected June 1, 2021*\n+*May 6, 2021*\n \n-Django 3.2.2 fixes several bugs in 3.2.1.\n+Django 3.2.2 fixes a security issue and a bug in 3.2.1.\n+\n+CVE-2021-32052: Header injection possibility since ``URLValidator`` accepted newlines in input on Python 3.9.5+\n+===============================================================================================================\n+\n+On Python 3.9.5+, :class:`~django.core.validators.URLValidator` didn't prohibit\n+newlines and tabs. If you used values with newlines in HTTP response, you could\n+suffer from header injection attacks. Django itself wasn't vulnerable because\n+:class:`~django.http.HttpResponse` prohibits newlines in HTTP headers.\n+\n+Moreover, the ``URLField`` form field which uses ``URLValidator`` silently\n+removes newlines and tabs on Python 3.9.5+, so the possibility of newlines\n+entering your data only existed if you are using this validator outside of the\n+form fields.\n+\n+This issue was introduced by the :bpo:`43882` fix.\n \n Bugfixes\n ========\ndiff --git a/docs/releases/index.txt b/docs/releases/index.txt\nindex c714ea95b4bb..99c19b088a6b 100644\n--- a/docs/releases/index.txt\n+++ b/docs/releases/index.txt\n@@ -41,6 +41,7 @@ versions of the documentation contain the release notes for any later releases.\n .. toctree::\n    :maxdepth: 1\n \n+   3.1.10\n    3.1.9\n    3.1.8\n    3.1.7\n@@ -78,6 +79,7 @@ versions of the documentation contain the release notes for any later releases.\n .. toctree::\n    :maxdepth: 1\n \n+   2.2.22\n    2.2.21\n    2.2.20\n    2.2.19\ndiff --git a/tests/validators/tests.py b/tests/validators/tests.py\nindex d6d013c026db..09d5c40ff5bd 100644\n--- a/tests/validators/tests.py\n+++ b/tests/validators/tests.py\n@@ -226,9 +226,15 @@\n     (URLValidator(), None, ValidationError),\n     (URLValidator(), 56, ValidationError),\n     (URLValidator(), 'no_scheme', ValidationError),\n-    # Trailing newlines not accepted\n+    # Newlines and tabs are not accepted.\n     (URLValidator(), 'http://www.djangoproject.com/\\n', ValidationError),\n     (URLValidator(), 'http://[::ffff:192.9.5.5]\\n', ValidationError),\n+    (URLValidator(), 'http://www.djangoproject.com/\\r', ValidationError),\n+    (URLValidator(), 'http://[::ffff:192.9.5.5]\\r', ValidationError),\n+    (URLValidator(), 'http://www.django\\rproject.com/', ValidationError),\n+    (URLValidator(), 'http://[::\\rffff:192.9.5.5]', ValidationError),\n+    (URLValidator(), 'http://\\twww.djangoproject.com/', ValidationError),\n+    (URLValidator(), 'http://\\t[::ffff:192.9.5.5]', ValidationError),\n     # Trailing junk does not take forever to reject\n     (URLValidator(), 'http://www.asdasdasdasdsadfm.com.br ', ValidationError),\n     (URLValidator(), 'http://www.asdasdasdasdsadfm.com.br z', ValidationError),\n", "gold_standard_pr_link": "https://github.com/django/django/pull/14349"}