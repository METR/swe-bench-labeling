{"instance_id": "astropy__astropy-12907", "score": "I", "diff": "diff --git a/astropy/modeling/separable.py b/astropy/modeling/separable.py\nindex a308e27297..c608213f77 100644\n--- a/astropy/modeling/separable.py\n+++ b/astropy/modeling/separable.py\n@@ -306,6 +306,8 @@ def _separable(transform):\n     elif isinstance(transform, CompoundModel):\n         sepleft = _separable(transform.left)\n         sepright = _separable(transform.right)\n+        # Use the operator-specific function to combine sepleft and sepright\n+        # This handles both nested and non-nested CompoundModels correctly\n         return _operators[transform.op](sepleft, sepright)\n     elif isinstance(transform, Model):\n         return _coord_matrix(transform, 'left', transform.n_outputs)\ndiff --git a/pyproject.toml b/pyproject.toml\nindex 3364d30740..02dddbe713 100644\n--- a/pyproject.toml\n+++ b/pyproject.toml\n@@ -1,5 +1,5 @@\n [build-system]\n-requires = [\"setuptools\",\n+requires = [\"setuptools==68.0.0\",\n             \"setuptools_scm>=6.2\",\n             \"wheel\",\n             \"cython==0.29.22\",\ndiff --git a/test_separability.py b/test_separability.py\nnew file mode 100644\nindex 0000000000..a5c9ba4c6a\n--- /dev/null\n+++ b/test_separability.py\n@@ -0,0 +1,18 @@\n+from astropy.modeling import models as m\n+from astropy.modeling.separable import separability_matrix\n+\n+# Test case 1: Simple compound model\n+cm = m.Linear1D(10) & m.Linear1D(5)\n+print(\"Test case 1:\")\n+print(separability_matrix(cm))\n+\n+# Test case 2: More complex model\n+complex_model = m.Pix2Sky_TAN() & m.Linear1D(10) & m.Linear1D(5)\n+print(\"\\nTest case 2:\")\n+print(separability_matrix(complex_model))\n+\n+# Test case 3: Nested compound model\n+nested_model = m.Pix2Sky_TAN() & cm\n+print(\"\\nTest case 3:\")\n+print(separability_matrix(nested_model))\n+\n", "gold_standard_diff": "From 069729efbbb7f31dfb2d32496a4460c920e73511 Mon Sep 17 00:00:00 2001\nFrom: Stuart Mumford <stuart@cadair.com>\nDate: Thu, 3 Mar 2022 15:13:40 +0000\nSubject: [PATCH 1/3] Attempt to fix astropy/astropy#12906\n\n---\n astropy/modeling/separable.py            | 2 +-\n astropy/modeling/tests/test_separable.py | 9 ++++++++-\n 2 files changed, 9 insertions(+), 2 deletions(-)\n\ndiff --git a/astropy/modeling/separable.py b/astropy/modeling/separable.py\nindex a308e27297d1..45bea360859c 100644\n--- a/astropy/modeling/separable.py\n+++ b/astropy/modeling/separable.py\n@@ -242,7 +242,7 @@ def _cstack(left, right):\n         cright = _coord_matrix(right, 'right', noutp)\n     else:\n         cright = np.zeros((noutp, right.shape[1]))\n-        cright[-right.shape[0]:, -right.shape[1]:] = 1\n+        cright[-right.shape[0]:, -right.shape[1]:] = right\n \n     return np.hstack([cleft, cright])\n \ndiff --git a/astropy/modeling/tests/test_separable.py b/astropy/modeling/tests/test_separable.py\nindex 8dfe5c862665..ffb9351413a0 100644\n--- a/astropy/modeling/tests/test_separable.py\n+++ b/astropy/modeling/tests/test_separable.py\n@@ -52,7 +52,14 @@\n     'cm7': (map2 | p2 & sh1,\n             (np.array([False, True]),\n              np.array([[True, False], [False, True]]))\n-            )\n+            ),\n+    'cm8': (rot & (sh1 & sh2),\n+            (np.array([False, False, True, True]),\n+             np.array([[True, True, False, False],\n+                       [True, True, False, False],\n+                       [False, False, True, False],\n+                       [False, False, False, True]]))\n+            ),\n }\n \n \n\nFrom d05766f6355b9820868e3fb1e34e38e2c5c023ea Mon Sep 17 00:00:00 2001\nFrom: Stuart Mumford <stuart@cadair.com>\nDate: Fri, 4 Mar 2022 14:14:32 +0000\nSubject: [PATCH 2/3] More tests\n\n---\n astropy/modeling/tests/test_separable.py | 24 +++++++++++++++++-------\n 1 file changed, 17 insertions(+), 7 deletions(-)\n\ndiff --git a/astropy/modeling/tests/test_separable.py b/astropy/modeling/tests/test_separable.py\nindex ffb9351413a0..024b239508f5 100644\n--- a/astropy/modeling/tests/test_separable.py\n+++ b/astropy/modeling/tests/test_separable.py\n@@ -28,6 +28,13 @@\n p1 = models.Polynomial1D(1, name='p1')\n \n \n+cm_4d_expected = (np.array([False, False, True, True]),\n+                  np.array([[True,  True,  False, False],\n+                            [True,  True,  False, False],\n+                            [False, False, True,  False],\n+                            [False, False, False, True]]))\n+\n+\n compound_models = {\n     'cm1': (map3 & sh1 | rot & sh1 | sh1 & sh2 & sh1,\n             (np.array([False, False, True]),\n@@ -53,13 +60,16 @@\n             (np.array([False, True]),\n              np.array([[True, False], [False, True]]))\n             ),\n-    'cm8': (rot & (sh1 & sh2),\n-            (np.array([False, False, True, True]),\n-             np.array([[True, True, False, False],\n-                       [True, True, False, False],\n-                       [False, False, True, False],\n-                       [False, False, False, True]]))\n-            ),\n+    'cm8': (rot & (sh1 & sh2), cm_4d_expected),\n+    'cm9': (rot & sh1 & sh2, cm_4d_expected),\n+    'cm10': ((rot & sh1) & sh2, cm_4d_expected),\n+    'cm11': (rot & sh1 & (scl1 & scl2),\n+             (np.array([False, False, True, True, True]),\n+              np.array([[True,  True,  False, False, False],\n+                        [True,  True,  False, False, False],\n+                        [False, False, True,  False, False],\n+                        [False, False, False, True,  False],\n+                        [False, False, False, False, True]]))),\n }\n \n \n\nFrom efedd57cb088b6ca73f9540a3c6185ad7046c926 Mon Sep 17 00:00:00 2001\nFrom: Stuart Mumford <stuart@cadair.com>\nDate: Fri, 4 Mar 2022 14:15:54 +0000\nSubject: [PATCH 3/3] Add changelog\n\n---\n docs/changes/modeling/12907.bugfix.rst | 1 +\n 1 file changed, 1 insertion(+)\n create mode 100644 docs/changes/modeling/12907.bugfix.rst\n\ndiff --git a/docs/changes/modeling/12907.bugfix.rst b/docs/changes/modeling/12907.bugfix.rst\nnew file mode 100644\nindex 000000000000..a5d8c14706c3\n--- /dev/null\n+++ b/docs/changes/modeling/12907.bugfix.rst\n@@ -0,0 +1 @@\n+Fix computation of the separability of a ``CompoundModel`` where another ``CompoundModel`` is on the right hand side of the ``&`` operator.\n", "gold_standard_pr_link": "https://github.com/astropy/astropy/pull/12907"}