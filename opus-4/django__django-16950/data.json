{"instance_id": "django__django-16950", "score": "I", "diff": "diff --git a/test_uuid_inline_bug/admin.py b/test_uuid_inline_bug/admin.py\nnew file mode 100644\nindex 0000000000..ebd38d2470\n--- /dev/null\n+++ b/test_uuid_inline_bug/admin.py\n@@ -0,0 +1,11 @@\n+from django.contrib import admin\n+from .models import Thing, SubThing\n+\n+class SubThingInline(admin.StackedInline):\n+    model = SubThing\n+\n+@admin.register(Thing)\n+class ThingAdmin(admin.ModelAdmin):\n+    list_display = ('name',)\n+    ordering = ('pkid',)\n+    inlines = (SubThingInline,)\ndiff --git a/test_uuid_inline_bug/models.py b/test_uuid_inline_bug/models.py\nnew file mode 100644\nindex 0000000000..aef3188ff9\n--- /dev/null\n+++ b/test_uuid_inline_bug/models.py\n@@ -0,0 +1,21 @@\n+import uuid\n+from django.db import models\n+\n+class UUIDModel(models.Model):\n+    pkid = models.BigAutoField(primary_key=True, editable=False)\n+    id = models.UUIDField(default=uuid.uuid4, editable=False, unique=True)\n+    \n+    class Meta:\n+        abstract = True\n+\n+class Thing(UUIDModel):\n+    name = models.CharField(max_length=191)\n+\n+class SubThing(models.Model):\n+    name = models.CharField(max_length=191)\n+    thing = models.ForeignKey(\n+        'Thing',\n+        to_field='id',\n+        on_delete = models.CASCADE,\n+        related_name='subthings',\n+    )\ndiff --git a/test_uuid_inline_bug/test_issue.py b/test_uuid_inline_bug/test_issue.py\nnew file mode 100644\nindex 0000000000..3cb0e12d26\n--- /dev/null\n+++ b/test_uuid_inline_bug/test_issue.py\n@@ -0,0 +1,45 @@\n+import uuid\n+from django.test import TestCase\n+from django.db import models\n+\n+class UUIDModel(models.Model):\n+    pkid = models.BigAutoField(primary_key=True, editable=False)\n+    id = models.UUIDField(default=uuid.uuid4, editable=False, unique=True)\n+    \n+    class Meta:\n+        abstract = True\n+        app_label = 'test_uuid_inline_bug'\n+\n+class Thing(UUIDModel):\n+    name = models.CharField(max_length=191)\n+    \n+    class Meta:\n+        app_label = 'test_uuid_inline_bug'\n+\n+class SubThing(models.Model):\n+    name = models.CharField(max_length=191)\n+    thing = models.ForeignKey(\n+        'Thing',\n+        to_field='id',\n+        on_delete = models.CASCADE,\n+        related_name='subthings',\n+    )\n+    \n+    class Meta:\n+        app_label = 'test_uuid_inline_bug'\n+\n+class TestUUIDDefault(TestCase):\n+    def test_uuid_default_before_save(self):\n+        # Create a new instance without saving\n+        thing = Thing(name=\"Test Thing\")\n+        \n+        # Check if the UUID field has a value before saving\n+        print(f\"Before save - id attribute exists: {hasattr(thing, 'id')}\")\n+        print(f\"Before save - id value: {thing.id}\")\n+        print(f\"Before save - id type: {type(thing.id)}\")\n+        \n+        # Now save it\n+        thing.save()\n+        \n+        print(f\"After save - id value: {thing.id}\")\n+        print(f\"After save - id type: {type(thing.id)}\")\n", "gold_standard_diff": "From b91d62cca07638741f5902713983f71478589b0e Mon Sep 17 00:00:00 2001\nFrom: Neeraj Kumar <sainineeraj1234@gmail.com>\nDate: Fri, 7 Jul 2023 08:12:25 +0200\nSubject: [PATCH 1/2] Refs #24377 -- Added assertions for model inlines with\n primary key that has a default.\n\nThis ensures that a model field default is ignored.\n---\n tests/model_formsets/test_uuid.py | 2 ++\n 1 file changed, 2 insertions(+)\n\ndiff --git a/tests/model_formsets/test_uuid.py b/tests/model_formsets/test_uuid.py\nindex 2097bde82b58..2084fc2987b0 100644\n--- a/tests/model_formsets/test_uuid.py\n+++ b/tests/model_formsets/test_uuid.py\n@@ -43,6 +43,8 @@ def test_inlineformset_factory_ignores_default_pks_on_submit(self):\n             }\n         )\n         self.assertTrue(formset.is_valid())\n+        self.assertIsNone(formset.instance.uuid)\n+        self.assertIsNone(formset.forms[0].instance.parent_id)\n \n     def test_inlineformset_factory_nulls_default_pks_uuid_parent_auto_child(self):\n         \"\"\"\n\nFrom eed096574fea5c9d82d0dc5952ad439dfde13718 Mon Sep 17 00:00:00 2001\nFrom: Neeraj Kumar <sainineeraj1234@gmail.com>\nDate: Wed, 7 Jun 2023 01:27:32 +0530\nSubject: [PATCH 2/2] Fixed #32210 -- Fixed model inlines with to_field that\n has a default.\n\n---\n django/forms/models.py            |  8 +++++++-\n tests/model_formsets/test_uuid.py | 22 ++++++++++++++++++++++\n 2 files changed, 29 insertions(+), 1 deletion(-)\n\ndiff --git a/django/forms/models.py b/django/forms/models.py\nindex 3fa04b821fb1..dc30d79b5d3d 100644\n--- a/django/forms/models.py\n+++ b/django/forms/models.py\n@@ -1177,7 +1177,13 @@ def add_fields(self, form, index):\n                 to_field = self.instance._meta.get_field(kwargs[\"to_field\"])\n             else:\n                 to_field = self.instance._meta.pk\n-            if to_field.has_default():\n+\n+            if to_field.has_default() and (\n+                # Don't ignore a parent's auto-generated key if it's not the\n+                # parent model's pk and form data is provided.\n+                to_field.attname == self.fk.remote_field.model._meta.pk.name\n+                or not form.data\n+            ):\n                 setattr(self.instance, to_field.attname, None)\n \n         form.fields[name] = InlineForeignKeyField(self.instance, **kwargs)\ndiff --git a/tests/model_formsets/test_uuid.py b/tests/model_formsets/test_uuid.py\nindex 2084fc2987b0..0a2d504c8401 100644\n--- a/tests/model_formsets/test_uuid.py\n+++ b/tests/model_formsets/test_uuid.py\n@@ -93,3 +93,25 @@ def test_inlineformset_factory_nulls_default_pks_alternate_key_relation(self):\n         )\n         formset = FormSet()\n         self.assertIsNone(formset.forms[0].fields[\"parent\"].initial)\n+\n+    def test_inlineformset_factory_nulls_default_pks_alternate_key_relation_data(self):\n+        \"\"\"\n+        If form data is provided, a parent's auto-generated alternate key is\n+        set.\n+        \"\"\"\n+        FormSet = inlineformset_factory(\n+            ParentWithUUIDAlternateKey, ChildRelatedViaAK, fields=\"__all__\"\n+        )\n+        formset = FormSet(\n+            {\n+                \"childrelatedviaak_set-TOTAL_FORMS\": 3,\n+                \"childrelatedviaak_set-INITIAL_FORMS\": 0,\n+                \"childrelatedviaak_set-MAX_NUM_FORMS\": \"\",\n+                \"childrelatedviaak_set-0-name\": \"Test\",\n+                \"childrelatedviaak_set-1-name\": \"\",\n+                \"childrelatedviaak_set-2-name\": \"\",\n+            }\n+        )\n+        self.assertIs(formset.is_valid(), True)\n+        self.assertIsNotNone(formset.instance.uuid)\n+        self.assertEqual(formset.forms[0].instance.parent_id, formset.instance.uuid)\n", "gold_standard_pr_link": "https://github.com/django/django/pull/16950"}