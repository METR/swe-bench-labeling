From 3c9e53852dc70a9402690b01b96fc5d5c864fe84 Mon Sep 17 00:00:00 2001
From: Takeshi KOMIYA <i.tkomiya@gmail.com>
Date: Thu, 7 Oct 2021 00:07:17 +0900
Subject: [PATCH] Fix #9708: needs_extension failed to check double-digit
 version correctly

---
 CHANGES                 |  1 +
 sphinx/extension.py     | 15 ++++++++++++++-
 tests/test_extension.py | 31 +++++++++++++++++++++++++++++++
 3 files changed, 46 insertions(+), 1 deletion(-)
 create mode 100644 tests/test_extension.py

diff --git a/CHANGES b/CHANGES
index d2d8b0985a5..2ab2bc27f2c 100644
--- a/CHANGES
+++ b/CHANGES
@@ -59,6 +59,7 @@ Bugs fixed
 * #9649: HTML search: when objects have the same name but in different domains,
   return all of them as result instead of just one.
 * #9678: linkcheck: file extension was shown twice in warnings
+* #9708: needs_extension failed to check double-digit version correctly
 
 Testing
 --------
diff --git a/sphinx/extension.py b/sphinx/extension.py
index 7ec6c8518c3..34bf7763ad7 100644
--- a/sphinx/extension.py
+++ b/sphinx/extension.py
@@ -10,6 +10,8 @@
 
 from typing import TYPE_CHECKING, Any, Dict
 
+from packaging.version import InvalidVersion, Version
+
 from sphinx.config import Config
 from sphinx.errors import VersionRequirementError
 from sphinx.locale import __
@@ -51,7 +53,18 @@ def verify_needs_extensions(app: "Sphinx", config: Config) -> None:
                               'but it is not loaded.'), extname)
             continue
 
-        if extension.version == 'unknown version' or reqversion > extension.version:
+        fulfilled = True
+        if extension.version == 'unknown version':
+            fulfilled = False
+        else:
+            try:
+                if Version(reqversion) > Version(extension.version):
+                    fulfilled = False
+            except InvalidVersion:
+                if reqversion > extension.version:
+                    fulfilled = False
+
+        if not fulfilled:
             raise VersionRequirementError(__('This project needs the extension %s at least in '
                                              'version %s and therefore cannot be built with '
                                              'the loaded version (%s).') %
diff --git a/tests/test_extension.py b/tests/test_extension.py
new file mode 100644
index 00000000000..db9f4e48761
--- /dev/null
+++ b/tests/test_extension.py
@@ -0,0 +1,31 @@
+"""
+    test_extension
+    ~~~~~~~~~~~~~~
+
+    Test sphinx.extesion module.
+
+    :copyright: Copyright 2007-2021 by the Sphinx team, see AUTHORS.
+    :license: BSD, see LICENSE for details.
+"""
+
+import pytest
+
+from sphinx.errors import VersionRequirementError
+from sphinx.extension import Extension, verify_needs_extensions
+
+
+def test_needs_extensions(app):
+    # empty needs_extensions
+    assert app.config.needs_extensions == {}
+    verify_needs_extensions(app, app.config)
+
+    # needs_extensions fulfilled
+    app.config.needs_extensions = {'test.extension': '3.9'}
+    app.extensions['test.extension'] = Extension('test.extension', 'test.extension', version='3.10')
+    verify_needs_extensions(app, app.config)
+
+    # needs_extensions not fulfilled
+    app.config.needs_extensions = {'test.extension': '3.11'}
+    app.extensions['test.extension'] = Extension('test.extension', 'test.extension', version='3.10')
+    with pytest.raises(VersionRequirementError):
+        verify_needs_extensions(app, app.config)
