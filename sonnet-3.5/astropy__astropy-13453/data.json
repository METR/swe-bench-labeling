{"instance_id": "astropy__astropy-13453", "score": "I", "diff": "diff --git a/astropy/io/ascii/html.py b/astropy/io/ascii/html.py\nindex 266cf229cc..91901dbf0f 100644\n--- a/astropy/io/ascii/html.py\n+++ b/astropy/io/ascii/html.py\n@@ -168,6 +168,13 @@ class HTMLOutputter(core.TableOutputter):\n                 new_cols.append(col)\n                 col_num += 1\n \n+        # Apply formats if provided\n+        formats = meta.get('formats', {})\n+        for col in new_cols:\n+            if col.name in formats:\n+                format_func = formats[col.name]\n+                col.str_vals = [format_func(val) for val in col.data]\n+\n         return super().__call__(new_cols, meta)\n \n \n@@ -366,6 +373,13 @@ class HTML(core.BaseReader):\n         # Kwargs that get passed on to bleach.clean() if that is available.\n         raw_html_clean_kwargs = self.html.get('raw_html_clean_kwargs', {})\n \n+        # Pass the formats to the HTMLOutputter\n+        self.outputter = HTMLOutputter()\n+        meta = {'formats': self.html.get('formats', {})}\n+\n+        # Use super().write() to generate the HTML output\n+        html_output = super().write(table, outputter=self.outputter, meta=meta)\n+\n         # Use XMLWriter to output HTML to lines\n         w = writer.XMLWriter(ListWriter(lines))\n \ndiff --git a/pyproject.toml b/pyproject.toml\nindex 7a3b85fc92..83f08ed124 100644\n--- a/pyproject.toml\n+++ b/pyproject.toml\n@@ -1,5 +1,5 @@\n [build-system]\n-requires = [\"setuptools\",\n+requires = [\"setuptools==68.0.0\",\n             \"setuptools_scm>=6.2\",\n             \"wheel\",\n             \"cython==0.29.30\",\n", "gold_standard_diff": "From b66d545d2c52bcac4bb0de571ffb0bcb3b3fd182 Mon Sep 17 00:00:00 2001\nFrom: Matthew Pitkin <matthew.pitkin@ligo.org>\nDate: Thu, 14 Jul 2022 10:58:00 +0100\nSubject: [PATCH 1/4] Make HTML Table writer respect supplied output formatting\n  - Resolves #13451\n\n---\n astropy/io/ascii/html.py | 7 +++++++\n 1 file changed, 7 insertions(+)\n\ndiff --git a/astropy/io/ascii/html.py b/astropy/io/ascii/html.py\nindex 266cf229cc2c..33c8fff417bc 100644\n--- a/astropy/io/ascii/html.py\n+++ b/astropy/io/ascii/html.py\n@@ -250,6 +250,12 @@ def end_line(self, lines):\n             return None\n         return last_index + 1\n \n+    def _set_col_formats(self, cols):\n+        \"\"\"WRITE: set column formats.\"\"\"\n+        for col in cols:\n+            if col.info.name in self.formats:\n+                col.info.format = self.formats[col.info.name]\n+\n \n class HTML(core.BaseReader):\n     \"\"\"HTML format table.\n@@ -354,6 +360,7 @@ def write(self, table):\n             self.data.fill_values = [self.data.fill_values]\n \n         self.data._set_fill_values(cols)\n+        self.data._set_col_formats(cols)\n \n         lines = []\n \n\nFrom 87d8b2f5f43a4d3e4eeee4b0f84b00147d17bcfb Mon Sep 17 00:00:00 2001\nFrom: Matthew Pitkin <matthew.pitkin@ligo.org>\nDate: Thu, 14 Jul 2022 11:38:06 +0100\nSubject: [PATCH 2/4] Add test for HTML Table formatting\n\n---\n astropy/io/ascii/tests/test_html.py | 43 +++++++++++++++++++++++++++++\n 1 file changed, 43 insertions(+)\n\ndiff --git a/astropy/io/ascii/tests/test_html.py b/astropy/io/ascii/tests/test_html.py\nindex 0515efa06dac..dcfd2229bd48 100644\n--- a/astropy/io/ascii/tests/test_html.py\n+++ b/astropy/io/ascii/tests/test_html.py\n@@ -717,6 +717,49 @@ def test_multi_column_write_table_html_fill_values_masked():\n     assert buffer_output.getvalue() == buffer_expected.getvalue()\n \n \n+def test_write_table_formatted_columns():\n+    \"\"\"\n+    Test to make sure that the HTML writer writes out using the\n+    supplied formatting.\n+    \"\"\"\n+\n+    col1 = [1, 2]\n+    col2 = [1.234567e-11, -9.876543e11]\n+    formats = {\"C1\": \"04d\", \"C2\": \".2e\"}\n+    table = Table([col1, col2], names=formats.keys())\n+\n+    expected = \"\"\"\\\n+<html>\n+ <head>\n+  <meta charset=\"utf-8\"/>\n+  <meta content=\"text/html;charset=UTF-8\" http-equiv=\"Content-type\"/>\n+ </head>\n+ <body>\n+  <table>\n+   <thead>\n+    <tr>\n+     <th>C1</th>\n+     <th>C2</th>\n+    </tr>\n+   </thead>\n+   <tr>\n+    <td>0001</td>\n+    <td>1.23e-11</td>\n+   </tr>\n+   <tr>\n+    <td>0002</td>\n+    <td>-9.88e+11</td>\n+   </tr>\n+  </table>\n+ </body>\n+</html>\n+    \"\"\"\n+    with StringIO() as sp:\n+        table.write(sp, format=\"html\", formats=formats)\n+        out = sp.getvalue().strip()\n+    assert out == expected.strip()\n+\n+\n @pytest.mark.skipif('not HAS_BS4')\n def test_read_html_unicode():\n     \"\"\"\n\nFrom d5002202ecf1e43787680ded9d4f43146c352e87 Mon Sep 17 00:00:00 2001\nFrom: Matthew Pitkin <matthew.pitkin@ligo.org>\nDate: Thu, 14 Jul 2022 11:49:08 +0100\nSubject: [PATCH 3/4] Add changelog for #13453\n\n---\n docs/changes/io.ascii/13453.bugfix.rst | 3 +++\n 1 file changed, 3 insertions(+)\n create mode 100644 docs/changes/io.ascii/13453.bugfix.rst\n\ndiff --git a/docs/changes/io.ascii/13453.bugfix.rst b/docs/changes/io.ascii/13453.bugfix.rst\nnew file mode 100644\nindex 000000000000..658c4ed07e76\n--- /dev/null\n+++ b/docs/changes/io.ascii/13453.bugfix.rst\n@@ -0,0 +1,3 @@\n+When writing out a :class:`~astropy.table.Table` to HTML format, the\n+``formats`` keyword argument to the :meth:`~astropy.table.Table.write` method\n+will now be applied.\n\nFrom 163783bff90213846d1b7f59f78ad49382642c67 Mon Sep 17 00:00:00 2001\nFrom: Matthew Pitkin <matthew.pitkin@ligo.org>\nDate: Thu, 14 Jul 2022 13:35:00 +0100\nSubject: [PATCH 4/4] Fix so that the preexiting _set_col_formats method can be\n used\n\n---\n astropy/io/ascii/html.py | 9 ++-------\n 1 file changed, 2 insertions(+), 7 deletions(-)\n\ndiff --git a/astropy/io/ascii/html.py b/astropy/io/ascii/html.py\nindex 33c8fff417bc..c5a110514588 100644\n--- a/astropy/io/ascii/html.py\n+++ b/astropy/io/ascii/html.py\n@@ -250,12 +250,6 @@ def end_line(self, lines):\n             return None\n         return last_index + 1\n \n-    def _set_col_formats(self, cols):\n-        \"\"\"WRITE: set column formats.\"\"\"\n-        for col in cols:\n-            if col.info.name in self.formats:\n-                col.info.format = self.formats[col.info.name]\n-\n \n class HTML(core.BaseReader):\n     \"\"\"HTML format table.\n@@ -355,12 +349,13 @@ def write(self, table):\n         cols = list(table.columns.values())\n \n         self.data.header.cols = cols\n+        self.data.cols = cols\n \n         if isinstance(self.data.fill_values, tuple):\n             self.data.fill_values = [self.data.fill_values]\n \n         self.data._set_fill_values(cols)\n-        self.data._set_col_formats(cols)\n+        self.data._set_col_formats()\n \n         lines = []\n \n", "gold_standard_pr_link": "https://github.com/astropy/astropy/pull/13453"}